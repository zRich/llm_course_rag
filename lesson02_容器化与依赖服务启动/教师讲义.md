# Lesson 02 - 容器化与依赖服务启动

## 课程概述

本节课将带领学生学习如何使用Docker容器化技术来搭建企业级RAG系统的开发环境。学生将掌握Docker的基本概念、Docker Compose的使用，以及如何启动和管理RAG系统所需的各种依赖服务。

## 教学目标

### 知识目标
- 理解容器化技术的核心概念和优势
- 掌握Docker和Docker Compose的基本使用
- 了解企业级应用的服务架构设计
- 学习微服务环境下的服务编排

### 技能目标
- 能够编写Dockerfile构建应用镜像
- 能够使用Docker Compose编排多服务应用
- 能够配置和启动PostgreSQL、Redis、Qdrant、MinIO等服务
- 能够进行服务间的网络配置和数据持久化

### 素养目标
- 培养系统性思维和架构设计能力
- 建立DevOps和基础设施即代码的理念
- 提升问题排查和调试能力

## 核心内容

### 1. 容器化技术概述

#### 1.1 什么是容器化
- **定义**：容器化是一种操作系统级虚拟化技术
- **核心概念**：
  - 镜像（Image）：只读模板，包含运行应用所需的一切
  - 容器（Container）：镜像的运行实例
  - 仓库（Registry）：存储和分发镜像的服务

#### 1.2 容器化的优势
- **环境一致性**：开发、测试、生产环境完全一致
- **资源效率**：比虚拟机更轻量，启动更快
- **可移植性**：一次构建，到处运行
- **可扩展性**：易于水平扩展和负载均衡
- **隔离性**：进程、网络、文件系统隔离

#### 1.3 Docker vs 传统部署
```
传统部署：
应用A → 操作系统 → 物理服务器
应用B → 操作系统 → 物理服务器

Docker部署：
应用A容器 ↘
应用B容器 → Docker引擎 → 操作系统 → 物理服务器
应用C容器 ↗
```

### 2. Docker基础

#### 2.1 Docker核心组件
- **Docker Engine**：容器运行时
- **Docker CLI**：命令行接口
- **Docker Desktop**：图形化管理工具
- **Docker Hub**：官方镜像仓库

#### 2.2 常用Docker命令
```bash
# 镜像管理
docker images          # 列出本地镜像
docker pull <image>    # 拉取镜像
docker build -t <tag> . # 构建镜像
docker rmi <image>     # 删除镜像

# 容器管理
docker ps              # 列出运行中的容器
docker ps -a           # 列出所有容器
docker run <image>     # 运行容器
docker stop <container> # 停止容器
docker rm <container>  # 删除容器

# 调试命令
docker logs <container> # 查看容器日志
docker exec -it <container> bash # 进入容器
```

#### 2.3 Dockerfile最佳实践
- **使用官方基础镜像**：如python:3.11-slim
- **最小化层数**：合并RUN命令
- **利用缓存**：将变化频繁的指令放在后面
- **多阶段构建**：减小最终镜像大小
- **非root用户**：提高安全性

### 3. Docker Compose服务编排

#### 3.1 Docker Compose概述
- **定义**：用于定义和运行多容器Docker应用的工具
- **配置文件**：docker-compose.yml（YAML格式）
- **核心概念**：
  - 服务（Service）：容器的抽象定义
  - 网络（Network）：服务间通信
  - 卷（Volume）：数据持久化

#### 3.2 Compose文件结构
```yaml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - db
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: mydb
volumes:
  db_data:
networks:
  app_network:
```

#### 3.3 常用Compose命令
```bash
docker-compose up -d      # 后台启动所有服务
docker-compose down       # 停止并删除所有服务
docker-compose ps         # 查看服务状态
docker-compose logs       # 查看服务日志
docker-compose exec <service> bash # 进入服务容器
```

### 4. RAG系统依赖服务

#### 4.1 服务架构设计
```
┌─────────────────┐    ┌─────────────────┐
│   FastAPI App   │    │   PostgreSQL    │
│   (Web服务)     │────│   (关系数据库)   │
└─────────────────┘    └─────────────────┘
         │                       │
         │              ┌─────────────────┐
         │──────────────│     Redis       │
         │              │   (缓存数据库)   │
         │              └─────────────────┘
         │
         │              ┌─────────────────┐
         │──────────────│     Qdrant      │
         │              │   (向量数据库)   │
         │              └─────────────────┘
         │
         │              ┌─────────────────┐
         └──────────────│     MinIO       │
                        │   (对象存储)     │
                        └─────────────────┘
```

#### 4.2 各服务职责
- **PostgreSQL**：存储结构化数据（用户、文档元数据、配置等）
- **Redis**：缓存热点数据、会话存储、任务队列
- **Qdrant**：向量存储和相似性搜索
- **MinIO**：文件存储（PDF、图片等）
- **Prometheus**：监控指标收集
- **Grafana**：监控数据可视化

#### 4.3 服务配置要点

**PostgreSQL配置**：
- 数据库名称、用户名、密码
- 连接池配置
- 数据持久化

**Redis配置**：
- 内存限制
- 持久化策略
- 密码认证

**Qdrant配置**：
- API端口
- 数据存储路径
- 集合配置

**MinIO配置**：
- 访问密钥
- 存储桶策略
- 数据持久化

### 5. 网络和数据管理

#### 5.1 Docker网络
- **桥接网络**：默认网络模式
- **自定义网络**：服务间隔离和通信
- **服务发现**：通过服务名访问

#### 5.2 数据持久化
- **命名卷**：Docker管理的持久化存储
- **绑定挂载**：主机目录映射
- **数据备份**：定期备份策略

#### 5.3 环境变量管理
- **.env文件**：敏感信息配置
- **环境隔离**：开发、测试、生产环境
- **配置验证**：启动时检查必需配置

## 实践演示

### 演示1：创建Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY src/ ./src/

EXPOSE 8000

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 演示2：编写docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://rag:ragpass@postgres:5432/rag_db
    depends_on:
      - postgres
      - redis
      - qdrant

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: rag_db
      POSTGRES_USER: rag
      POSTGRES_PASSWORD: ragpass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  postgres_data:
```

### 演示3：服务启动和验证
```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs app

# 测试服务连接
curl http://localhost:8000/health
```

## 课堂互动设计

### 互动1：容器化优势讨论（10分钟）
**问题**："传统部署方式在团队协作中会遇到哪些问题？容器化如何解决这些问题？"
**形式**：小组讨论 + 代表发言
**要点**：
- 环境不一致问题
- 依赖冲突问题
- 部署复杂性问题

### 互动2：服务架构设计（15分钟）
**问题**："如果要设计一个电商推荐系统，你会选择哪些服务组件？为什么？"
**形式**：白板绘图 + 小组展示
**要点**：
- 服务职责划分
- 数据流设计
- 扩展性考虑

### 互动3：故障排查演练（10分钟）
**场景**：模拟容器启动失败
**问题**："如何快速定位和解决容器启动问题？"
**形式**：实际操作 + 经验分享
**要点**：
- 查看日志
- 检查配置
- 网络连通性

## 技术难点

### 难点1：网络配置
**问题**：服务间无法通信
**原因**：
- 网络配置错误
- 端口映射问题
- 防火墙限制

**解决方案**：
- 使用自定义网络
- 正确配置端口映射
- 检查安全组设置

### 难点2：数据持久化
**问题**：容器重启后数据丢失
**原因**：
- 未配置数据卷
- 卷挂载路径错误
- 权限问题

**解决方案**：
- 使用命名卷
- 正确设置挂载点
- 配置适当权限

### 难点3：环境变量管理
**问题**：敏感信息泄露
**原因**：
- 硬编码密码
- .env文件提交到版本控制
- 环境变量未正确传递

**解决方案**：
- 使用.env文件
- 配置.gitignore
- 使用Docker secrets

## 课后作业

### 基础作业
1. **容器化应用**（必做）
   - 为第一课的FastAPI应用编写Dockerfile
   - 构建镜像并运行容器
   - 验证应用正常工作

2. **多服务编排**（必做）
   - 编写docker-compose.yml文件
   - 启动PostgreSQL和Redis服务
   - 配置应用连接数据库

### 进阶作业
3. **完整服务栈**（选做）
   - 添加Qdrant和MinIO服务
   - 配置服务间网络
   - 实现数据持久化

4. **监控配置**（选做）
   - 添加Prometheus和Grafana
   - 配置基础监控指标
   - 创建监控面板

### 思考作业
5. **架构优化**（选做）
   - 分析当前架构的优缺点
   - 提出改进建议
   - 考虑生产环境部署方案

## 评估标准

### 基础要求（60分）
- [ ] 成功创建Dockerfile
- [ ] 应用容器正常运行
- [ ] docker-compose.yml配置正确
- [ ] 基础服务启动成功

### 进阶要求（80分）
- [ ] 完整服务栈部署
- [ ] 数据持久化配置
- [ ] 网络配置正确
- [ ] 环境变量管理规范

### 优秀要求（100分）
- [ ] 监控系统配置
- [ ] 安全配置完善
- [ ] 性能优化考虑
- [ ] 文档完整清晰

## 常见问题解决

### Q1: Docker Desktop启动失败
**症状**：Docker Desktop无法启动或频繁崩溃
**解决方案**：
1. 检查系统要求（内存、虚拟化支持）
2. 重启Docker Desktop服务
3. 清理Docker数据目录
4. 重新安装Docker Desktop

### Q2: 容器无法访问外网
**症状**：容器内无法下载依赖或访问外部API
**解决方案**：
1. 检查DNS配置
2. 配置代理设置
3. 检查防火墙规则
4. 使用--network=host模式测试

### Q3: 数据库连接失败
**症状**：应用无法连接到数据库容器
**解决方案**：
1. 检查服务名称和端口
2. 确认数据库已完全启动
3. 验证网络连通性
4. 检查认证信息

### Q4: 容器内存不足
**症状**：容器因内存不足被杀死
**解决方案**：
1. 增加Docker内存限制
2. 优化应用内存使用
3. 使用更轻量的基础镜像
4. 配置swap空间

## 参考资料

### 官方文档
- [Docker官方文档](https://docs.docker.com/)
- [Docker Compose文档](https://docs.docker.com/compose/)
- [PostgreSQL Docker镜像](https://hub.docker.com/_/postgres)
- [Redis Docker镜像](https://hub.docker.com/_/redis)

### 最佳实践
- [Dockerfile最佳实践](https://docs.docker.com/develop/dev-best-practices/)
- [Docker安全指南](https://docs.docker.com/engine/security/)
- [容器化应用的12要素](https://12factor.net/)

### 学习资源
- [Docker入门教程](https://docker-curriculum.com/)
- [Compose文件参考](https://docs.docker.com/compose/compose-file/)
- [容器编排最佳实践](https://kubernetes.io/docs/concepts/)

## 下节课预告

**Lesson 03 - 数据模型与迁移**

下节课我们将学习：
- SQLModel数据模型设计
- PostgreSQL数据库设计
- 数据迁移和版本管理
- 连接池配置和优化
- 数据库操作最佳实践

**预习建议**：
1. 复习SQL基础语法
2. 了解ORM概念
3. 阅读SQLModel文档
4. 思考RAG系统需要哪些数据表

通过本节课的学习，学生将掌握容器化技术的核心概念和实践技能，为后续的企业级RAG系统开发奠定坚实的基础设施基础。