# Lesson 14 · 缓存策略（Cache Strategy）

本课围绕 RAG 系统的缓存策略设计与优化，聚焦“命中率、延时、成本”三项核心指标，通过可度量、可验证的端到端演示，指导你在检索与问答链路中合理引入与评估缓存。

## 课次信息
- 课程：RAG
- 课次：14
- 主题：缓存策略与命中率优化
- 时长：90 分钟（含演示与互动）
- 先修：Lesson 12（多文档源处理）、Lesson 13（引用与可溯源输出）
- 关联：Lesson 15（评估与监控）

## 教学目标（SMART）
- 指标化：在固定问题集上，缓存命中率≥70%（热问场景）；P95 响应延时下降≥30%；调用成本下降≥20%。
- 可验证：提供统一请求示例与提交流程，支持端到端复现与验收。
- 一致性：缓存不破坏引用可定位性与答案一致性，失效策略明确。

## 教学重点与难点
- 重点：缓存键设计与标准化；多层缓存（Embedding/检索/重排/QA）协同；失效与预热策略；指标与收益评估。
- 难点：键覆盖不全导致“伪命中”；TTL 与主动失效的权衡；热问与长尾问的分层策略；一致性与新鲜度的平衡。

## 知识点详解
### 1) 缓存分层
- Embedding 缓存：对相同文本或问题去重向量化，键包括`normalized_text`、`model_id`、`dim`等。
- 检索（Retrieve）缓存：对检索结果列表缓存，键包括`query_norm`、`filters_norm`、`top_k`、`fusion.strategy`等。
- 重排（Rerank）缓存：对候选列表的重排结果缓存，键包括`candidate_ids_hash`、`rerank_model_id`、`top_m`等。
- QA/生成缓存：对最终答案（含引用片段）缓存，键包括`query_norm`、`context_ids_hash`、`prompt_id`、`style`等。

### 2) 键设计与标准化
- 统一规范：键必须覆盖会影响结果的所有输入维度（查询、过滤、策略、模型、样式等）。
- 标准化：
  - 文本：大小写归一、去除多余空白、同义词规范（必要时）。
  - 结构：字段排序与序列化一致（JSON Canonicalization）。
  - 版本：模型/提示/索引版本号纳入键。
- 哈希与长度：键建议短哈希存储，另保留可读映射用于诊断。

### 3) 失效、预热与分层
- TTL：为不同层设置差异化 TTL（如检索>QA）；避免过期雪崩（添加随机抖动）。
- 主动失效：当文档新增/更新/删除时，触发相关键范围失效（基于文档 ID、索引版本）。
- 预热（Warm-up）：对已知问题集或热门查询在课前/上线前预热，提升首轮命中。
- 冷/温/热分层：基于访问频率与收益评估分配容量与 TTL。

### 4) 指标与收益
- 命中率（Hit Rate）：`hits / (hits + misses)`；分层统计（检索、重排、QA）。
- 延时（Latency）：关注 P95/P99；命中与未命中分桶比较。
- 成本（Cost）：按模型调用、向量检索、网络请求等归因；缓存命中节省的调用量。
- 一致性风险：命中后答案/引用偏差的监控与告警；对不可定位引用拒绝缓存或缩短 TTL。

### 5) 边界与合规
- 不可虚构/伪造：缓存内容须源自真实检索与生成；引用可定位且字段一致。
- 版本一致性：模型、索引与提示版本变更须触发相关键失效。
- 数据隐私：区分用户级/租户级缓存边界；避免跨租户污染。

## 完整示例与演示
演示目标：展示开启缓存后，同一查询的第二次调用显著降低延时与成本，并保留可定位引用。

1) 环境准备
- 配置：`CACHE_ENABLED=true`，`CACHE_TTL_SEC=300`，`CACHE_KEY_FIELDS=[query,filters,top_k,fusion.strategy,rerank_top_m,model_id,prompt_id,style]`
- 预热：对 Top-10 热问进行一次检索与 QA 调用。

2) 检索与问答（两次调用对比）
- 第一次：`miss`，记录延时/成本与引用片段。
- 第二次：`hit`，延时显著下降、成本降低，引用片段与字段保持一致。

3) 失效与一致性
- 更新一份源文档（如新增一段内容），触发相关键失效；再次调用应为`miss`并返回新内容引用。

配套示例见 `examples/input.json` 与错误响应 `examples/error_response.json`。

## 授课老师指导
- 时间轴：10/20/25/25/10（开场/概念/演示/互动/总结）。
- 强调：键覆盖、TTL 与主动失效、命中率与一致性并重。
- 提示：现场展示日志中的 `cache_hit=true/false` 与命中层级；讲解常见伪命中来源。

## 学生任务
- 为检索与 QA 端到端链路设计并实现缓存键、TTL 与主动失效；完成预热脚本与指标记录。
- 在提供的问题集上达到目标指标，并输出对比表与结论。

## 对齐与连续性
- 与 Lesson 12：保持多源字段与检索契约一致，键覆盖多源特有字段（如来源类型）。
- 与 Lesson 13：引用字段命名与样式一致；不可缓存不可定位引用。
- 与 Lesson 15：指标采集埋点与报表格式对齐，复用监控面板。

## 提交与验收标准
- 命中率与延时：提供`baseline vs cache-enabled`的命中率与 P95 延时对比；截图与原始日志片段。
- 成本：展示模型与检索调用量下降比例；给出计算方法与原始计数。
- 一致性：随机抽样核验引用片段与答案一致；不可定位引用不得命中缓存。
- 配置与脚本：附 `.env`、预热与失效脚本、关键日志片段。
- 复现：助教可在本机按 `templates/submission.md` 复现全部结论。

## 术语与概念
- 缓存键（Cache Key）：唯一标识某次可缓存计算输入的组合。
- 命中（Hit）/未命中（Miss）：访问缓存是否返回有效数据。
- TTL：缓存项有效期；到期自动失效。
- 主动失效：由事件触发的清理，如文档更新与版本变更。
- 预热（Warm-up）：提前填充缓存以提升初次访问体验。
- 冷/温/热分层：按访问频率与收益分配缓存资源。

## 边界声明
- 缓存不得改变真实答案或引用；版本变更优先失效。
- 对隐私与隔离有严格要求的场景（多租户/个人数据）需采用用户级或租户级键空间。

---
配套文件：`teacher-script.md`、`blackboard-steps.md`、`checklist.md`、`examples/`、`templates/submission.md`。