# Lesson 01 - 课程导入与环境准备

## 实验目标

通过本次实验，你将：
- 搭建完整的Python开发环境
- 掌握uv依赖管理工具的使用
- 创建基础的FastAPI应用
- 了解企业级开发的最佳实践

## 环境准备

### 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, 或 Linux
- **Python版本**: >= 3.10
- **内存**: 至少 4GB RAM
- **存储**: 至少 2GB 可用空间

### 必需软件
1. **Python 3.10+**
   - Windows: 从 [python.org](https://python.org) 下载安装
   - macOS: 使用 Homebrew `brew install python@3.10`
   - Linux: 使用包管理器 `sudo apt install python3.10`

2. **Git**
   - 从 [git-scm.com](https://git-scm.com) 下载安装

3. **VSCode**
   - 从 [code.visualstudio.com](https://code.visualstudio.com) 下载安装
   - 安装Python扩展包

4. **Docker Desktop**（可选，下节课使用）
   - 从 [docker.com](https://docker.com) 下载安装

## 实验一：环境搭建与验证

### 步骤1：验证Python环境

```bash
# 检查Python版本
python --version
# 或者
python3 --version

# 确保版本 >= 3.10
```

### 步骤2：安装uv依赖管理工具

```bash
# 使用pip安装uv
pip install uv

# 验证安装
uv --version
```

### 步骤3：获取项目代码

我们将使用Git分支管理来获取不同课程阶段的代码。首先克隆项目仓库：

```bash
# 克隆项目仓库
git clone <仓库地址> rag-system
cd rag-system

# 切换到lesson01分支
git checkout lesson01

# 验证当前分支和代码状态
git branch
ls -la
```

**说明**：
- 项目使用Git分支管理不同课程阶段的代码
- `lesson01`分支包含第一课的完整代码结构
- 后续课程将切换到对应的分支（lesson02、lesson03等）
- 这种方式避免了手动复制代码，确保代码版本的一致性

### 步骤4：初始化Python虚拟环境

```bash
# 使用uv创建虚拟环境
uv venv

# 激活虚拟环境
# Windows
.venv\Scripts\activate

# macOS/Linux
source .venv/bin/activate

# 验证虚拟环境
which python
# 应该显示虚拟环境中的Python路径
```

### 步骤5：安装基础依赖

```bash
# 安装FastAPI和Uvicorn
uv pip install fastapi uvicorn[standard]

# 验证安装
python -c "import fastapi; print(fastapi.__version__)"
python -c "import uvicorn; print(uvicorn.__version__)"
```

## 实验二：创建基础FastAPI应用

### 步骤1：创建主应用文件

创建 `src/main.py` 文件：

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Optional
import time

# 创建FastAPI应用实例
app = FastAPI(
    title="RAG System API",
    description="企业级RAG系统接口 - 第一课演示",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# 定义数据模型
class HealthResponse(BaseModel):
    status: str
    message: str
    timestamp: float

class QueryRequest(BaseModel):
    query: str
    max_results: Optional[int] = 5

class QueryResponse(BaseModel):
    answer: str
    sources: List[str]
    processing_time: float
    query: str

# 根路径
@app.get("/", response_model=HealthResponse)
def root():
    """根路径 - 返回服务基本信息"""
    return HealthResponse(
        status="success",
        message="RAG System is running! 访问 /docs 查看API文档",
        timestamp=time.time()
    )

# 健康检查接口
@app.get("/health", response_model=HealthResponse)
def health_check():
    """健康检查接口"""
    return HealthResponse(
        status="healthy",
        message="All systems operational",
        timestamp=time.time()
    )

# 查询接口（临时实现）
@app.post("/query", response_model=QueryResponse)
def query_endpoint(request: QueryRequest):
    """查询接口 - 临时实现，后续课程会完善"""
    start_time = time.time()
    
    # 模拟处理时间
    time.sleep(0.1)
    
    processing_time = time.time() - start_time
    
    return QueryResponse(
        answer=f"这是对查询'{request.query}'的临时回答。在后续课程中，我们将实现真正的RAG检索和生成功能。",
        sources=[
            "临时数据源1 - 企业知识库",
            "临时数据源2 - 技术文档",
            "临时数据源3 - 最佳实践指南"
        ],
        processing_time=processing_time,
        query=request.query
    )

# 获取系统信息
@app.get("/system/info")
def get_system_info():
    """获取系统信息"""
    import sys
    import platform
    
    return {
        "python_version": sys.version,
        "platform": platform.platform(),
        "fastapi_version": "已安装",
        "status": "开发环境已就绪"
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000, reload=True)
```

### 步骤2：创建启动脚本

创建 `scripts/start_dev.py` 文件：

```python
#!/usr/bin/env python3
"""
开发环境启动脚本
"""

import uvicorn
import sys
import os

# 添加src目录到Python路径
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

def main():
    """启动开发服务器"""
    print("🚀 启动RAG系统开发服务器...")
    print("📖 API文档地址: http://127.0.0.1:8000/docs")
    print("📋 ReDoc文档: http://127.0.0.1:8000/redoc")
    print("🔧 按 Ctrl+C 停止服务器")
    
    uvicorn.run(
        "main:app",
        host="127.0.0.1",
        port=8000,
        reload=True,
        reload_dirs=["src"],
        log_level="info"
    )

if __name__ == "__main__":
    main()
```

### 步骤3：创建配置文件

创建 `.env.example` 文件：

```env
# 应用配置
APP_NAME=RAG System
APP_VERSION=1.0.0
DEBUG=true

# 服务器配置
HOST=127.0.0.1
PORT=8000

# 数据库配置（后续课程使用）
DATABASE_URL=postgresql://rag:ragpass@localhost:5432/rag_db
REDIS_URL=redis://localhost:6379/0

# 向量数据库配置（后续课程使用）
QDRANT_URL=http://localhost:6333

# LLM配置（后续课程使用）
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1

# 日志配置
LOG_LEVEL=INFO
```

创建 `.env` 文件（复制 `.env.example`）：

```bash
cp .env.example .env
```

### 步骤4：创建Git忽略文件

创建 `.gitignore` 文件：

```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# 虚拟环境
.venv/
venv/
ENV/
env/

# 环境变量
.env
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# 操作系统
.DS_Store
Thumbs.db

# 日志文件
*.log
logs/

# 数据库
*.db
*.sqlite3

# 临时文件
tmp/
temp/
```

## 实验三：运行和测试应用

### 步骤1：启动应用

```bash
# 方法1：直接运行
cd src
python main.py

# 方法2：使用uvicorn命令
uvicorn main:app --reload --host 127.0.0.1 --port 8000

# 方法3：使用启动脚本
python scripts/start_dev.py
```

### 步骤2：验证应用运行

1. **访问根路径**
   - 打开浏览器访问: http://127.0.0.1:8000
   - 应该看到欢迎信息

2. **查看API文档**
   - 访问: http://127.0.0.1:8000/docs
   - 应该看到Swagger UI界面

3. **查看ReDoc文档**
   - 访问: http://127.0.0.1:8000/redoc
   - 应该看到ReDoc界面

### 步骤3：测试API接口

#### 使用浏览器测试

1. **健康检查**
   - 访问: http://127.0.0.1:8000/health

2. **系统信息**
   - 访问: http://127.0.0.1:8000/system/info

#### 使用Swagger UI测试

1. 打开 http://127.0.0.1:8000/docs
2. 点击 "POST /query" 接口
3. 点击 "Try it out"
4. 输入测试数据：
   ```json
   {
     "query": "什么是RAG系统？",
     "max_results": 3
   }
   ```
5. 点击 "Execute" 执行请求
6. 查看响应结果

#### 使用curl测试（可选）

```bash
# 测试健康检查
curl http://127.0.0.1:8000/health

# 测试查询接口
curl -X POST "http://127.0.0.1:8000/query" \
     -H "Content-Type: application/json" \
     -d '{
       "query": "什么是RAG系统？",
       "max_results": 3
     }'
```

## 实验四：代码优化和扩展

### 步骤1：添加配置管理

创建 `src/config.py` 文件：

```python
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    """应用配置"""
    
    # 应用基本信息
    app_name: str = "RAG System"
    app_version: str = "1.0.0"
    debug: bool = True
    
    # 服务器配置
    host: str = "127.0.0.1"
    port: int = 8000
    
    # 数据库配置
    database_url: Optional[str] = None
    redis_url: Optional[str] = None
    
    # 向量数据库配置
    qdrant_url: Optional[str] = None
    
    # LLM配置
    openai_api_key: Optional[str] = None
    openai_base_url: str = "https://api.openai.com/v1"
    
    # 日志配置
    log_level: str = "INFO"
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"

# 创建全局配置实例
settings = Settings()
```

### 步骤2：更新主应用文件

更新 `src/main.py`，使用配置管理：

```python
from fastapi import FastAPI
from pydantic import BaseModel
from typing import List, Optional
import time
from config import settings

# 使用配置创建FastAPI应用实例
app = FastAPI(
    title=settings.app_name,
    description="企业级RAG系统接口 - 第一课演示",
    version=settings.app_version,
    docs_url="/docs",
    redoc_url="/redoc",
    debug=settings.debug
)

# ... 其他代码保持不变 ...

# 添加配置信息接口
@app.get("/system/config")
def get_config_info():
    """获取配置信息（隐藏敏感信息）"""
    return {
        "app_name": settings.app_name,
        "app_version": settings.app_version,
        "debug": settings.debug,
        "log_level": settings.log_level,
        "database_configured": bool(settings.database_url),
        "redis_configured": bool(settings.redis_url),
        "qdrant_configured": bool(settings.qdrant_url),
        "openai_configured": bool(settings.openai_api_key)
    }
```

### 步骤3：安装额外依赖

```bash
# 安装配置管理依赖
uv pip install pydantic-settings

# 安装开发工具（可选）
uv pip install black isort mypy
```

## 实验验证

### 检查清单

- [ ] Python 3.10+ 环境已安装
- [ ] uv 依赖管理工具已安装
- [ ] 项目目录结构已创建
- [ ] 虚拟环境已创建并激活
- [ ] FastAPI 和 Uvicorn 已安装
- [ ] 基础应用代码已创建
- [ ] 应用能够正常启动
- [ ] 所有API接口能够正常访问
- [ ] Swagger UI 文档可以正常查看
- [ ] 配置管理功能正常工作

### 功能测试

1. **启动测试**
   ```bash
   python src/main.py
   # 应该看到服务器启动信息
   ```

2. **接口测试**
   - 访问 http://127.0.0.1:8000 - 应该返回欢迎信息
   - 访问 http://127.0.0.1:8000/health - 应该返回健康状态
   - 访问 http://127.0.0.1:8000/docs - 应该显示API文档

3. **查询测试**
   - 在Swagger UI中测试POST /query接口
   - 应该返回模拟的查询结果

## 思考题

1. **环境管理**
   - 为什么企业环境中更推荐 uv 或 poetry 来管理依赖，而不是直接 pip install？
   - 虚拟环境的作用是什么？不使用虚拟环境会有什么问题？

2. **技术选型**
   - FastAPI 相比 Flask 和 Django 有什么优势？
   - 为什么选择 FastAPI 作为 RAG 系统的后端框架？

3. **配置管理**
   - 为什么要使用 .env 文件管理配置？
   - 在不同环境（开发、测试、生产）中如何管理配置？

4. **API设计**
   - 为什么要使用 Pydantic 模型定义请求和响应？
   - 自动生成的API文档有什么价值？

5. **架构思考**
   - 本地开发环境与云端部署环境可能会有什么差异？
   - 如何确保开发环境和生产环境的一致性？

## 常见问题解决

### Q1: uv 安装失败
**问题**: `pip install uv` 报错
**解决方案**:
```bash
# 升级pip
python -m pip install --upgrade pip

# 重新安装uv
pip install uv

# 如果还是失败，尝试使用conda
conda install -c conda-forge uv
```

### Q2: 虚拟环境激活失败
**问题**: `source .venv/bin/activate` 不工作
**解决方案**:
```bash
# Windows用户使用
.venv\Scripts\activate

# 或者使用uv直接运行
uv run python src/main.py
```

### Q3: FastAPI启动报错
**问题**: 导入模块失败
**解决方案**:
```bash
# 确保在正确的目录
cd rag-course

# 确保虚拟环境已激活
source .venv/bin/activate

# 重新安装依赖
uv pip install fastapi uvicorn[standard]
```

### Q4: 端口被占用
**问题**: `Address already in use`
**解决方案**:
```bash
# 使用不同端口
uvicorn main:app --port 8001

# 或者找到并关闭占用进程
# Windows
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# macOS/Linux
lsof -ti:8000 | xargs kill -9
```

### Q5: 配置文件不生效
**问题**: .env 文件中的配置没有被读取
**解决方案**:
```bash
# 确保安装了pydantic-settings
uv pip install pydantic-settings

# 确保.env文件在正确位置（项目根目录）
ls -la .env

# 检查.env文件格式（不要有空格）
APP_NAME=RAG System  # 错误
APP_NAME="RAG System"  # 正确
```

## 参考资料

### 官方文档
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [uv 用户指南](https://docs.astral.sh/uv/)
- [Pydantic 文档](https://docs.pydantic.dev/)
- [Uvicorn 文档](https://www.uvicorn.org/)

### 学习资源
- [Python 虚拟环境最佳实践](https://realpython.com/python-virtual-environments-a-primer/)
- [FastAPI 教程系列](https://fastapi.tiangolo.com/tutorial/)
- [现代 Python 开发工具链](https://github.com/carlosperate/awesome-pyproject)

## 实验完成标志

当你完成以下所有项目时，说明实验成功：

✅ **环境搭建完成**
- Python 3.10+ 环境正常
- uv 工具安装成功
- 项目虚拟环境创建并激活

✅ **应用开发完成**
- FastAPI 应用创建成功
- 所有API接口正常工作
- Swagger UI 文档可以访问

✅ **配置管理完成**
- .env 文件配置正确
- 配置类正常工作
- 敏感信息得到保护

✅ **测试验证完成**
- 应用启动无错误
- 所有接口响应正常
- 文档生成正确

恭喜你完成了第一课的实验！你已经成功搭建了企业级RAG系统的基础开发环境，并创建了第一个FastAPI应用。在下一课中，我们将学习如何使用Docker容器化这个应用，并启动RAG系统需要的各种依赖服务。

## 实验完成后的Git操作

### 为什么要进行Git提交？

在完成每节课的实验后，进行Git提交是非常重要的最佳实践：

- **版本控制**: 记录你的学习进度和代码变更历史
- **备份保护**: 防止意外丢失你的实验成果
- **问题追踪**: 当出现问题时，可以回退到之前的工作状态
- **学习记录**: 为你的学习过程建立完整的版本历史
- **团队协作**: 在团队环境中，良好的提交习惯是必需的

### Git提交操作步骤

完成本课实验后，请按照以下步骤提交你的代码：

#### 步骤1：检查当前状态

```bash
# 查看当前Git状态
git status

# 查看具体的文件变更
git diff
```

**说明**: `git status` 会显示哪些文件被修改、添加或删除。红色表示未暂存的更改，绿色表示已暂存的更改。

#### 步骤2：添加文件到暂存区

```bash
# 添加所有更改的文件
git add .

# 或者选择性添加特定文件
git add src/main.py
git add src/config.py
git add .env.example

# 再次检查状态
git status
```

**说明**: `git add .` 会添加当前目录下所有更改的文件。如果你只想提交特定文件，可以单独指定文件路径。

#### 步骤3：提交更改

```bash
# 提交更改并添加描述信息
git commit -m "完成lesson01实验：搭建FastAPI基础环境和应用"

# 或者使用更详细的提交信息
git commit -m "完成lesson01实验

- 搭建Python 3.10+开发环境
- 安装并配置uv依赖管理工具
- 创建基础FastAPI应用和API接口
- 实现配置管理和环境变量处理
- 添加健康检查和系统信息接口
- 完成应用测试和验证"
```

**提交信息建议**:
- 使用清晰、简洁的中文描述
- 第一行简要说明主要变更
- 如有需要，可以添加详细的变更列表
- 遵循团队的提交信息规范

#### 步骤4：验证提交结果

```bash
# 查看提交历史
git log --oneline -5

# 查看最近一次提交的详细信息
git show HEAD
```

### 可选：推送到远程仓库

如果你使用的是远程Git仓库（如GitHub、GitLab等），可以将提交推送到远程：

```bash
# 推送到远程仓库的当前分支
git push origin lesson01

# 如果是第一次推送该分支
git push -u origin lesson01
```

### 常见问题和解决方案

#### Q1: 提交时出现"nothing to commit"错误
**原因**: 没有文件更改或所有更改已经提交
**解决方案**:
```bash
# 检查是否有未跟踪的文件
git status

# 如果有新文件，先添加再提交
git add .
git commit -m "你的提交信息"
```

#### Q2: 想要修改最后一次提交信息
**解决方案**:
```bash
# 修改最后一次提交的信息
git commit --amend -m "新的提交信息"
```

#### Q3: 不小心添加了不应该提交的文件
**解决方案**:
```bash
# 从暂存区移除文件（但保留本地更改）
git reset HEAD 文件名

# 或者移除所有暂存的文件
git reset HEAD
```

#### Q4: 想要查看某个文件的更改历史
**解决方案**:
```bash
# 查看文件的提交历史
git log --follow -- src/main.py

# 查看文件的具体更改
git log -p -- src/main.py
```

### Git最佳实践提醒

1. **频繁提交**: 完成一个功能点就提交一次，不要积累太多更改
2. **清晰信息**: 提交信息要清楚地描述做了什么更改
3. **检查再提交**: 提交前用 `git status` 和 `git diff` 检查更改
4. **忽略文件**: 确保 `.gitignore` 文件正确配置，避免提交不必要的文件
5. **分支管理**: 在正确的分支上工作和提交

### 下一步

完成Git提交后，你就可以安全地进入下一课的学习了。在lesson02中，我们将：
- 切换到 `lesson02` 分支
- 学习Docker容器化技术
- 启动RAG系统的依赖服务

记住，良好的Git习惯是软件开发的基础技能，坚持在每节课后进行提交，你将建立起完整的学习和开发历史记录。