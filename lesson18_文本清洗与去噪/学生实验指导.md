# 第18节课：文本清洗与去噪 - 学生实验指导

## 实验目标

通过本实验，学生将掌握：
1. 文本预处理的核心算法
2. 噪声检测与清理技术
3. 文本质量评估方法
4. 编码问题的检测和修复
5. 自动化清洗流程的设计

## 环境准备

### 1. 安装依赖

```bash
pip install chardet regex
```

### 2. 创建实验目录

```bash
mkdir lesson18_text_cleaning
cd lesson18_text_cleaning
```

## 实验步骤

### 步骤1: 创建文本清洗器

创建文件 `text_cleaner.py`：

```python
import re
from typing import List, Optional, Dict

class TextCleaner:
    def __init__(self, min_line_length: int = 5, max_line_length: int = 1000):
        self.min_line_length = min_line_length
        self.max_line_length = max_line_length
        
        # 定义无意义内容的正则模式
        self.meaningless_patterns = [
            re.compile(r'^[=\-_*#]{3,}$'),  # 分隔符行
            re.compile(r'^\d+$'),  # 纯数字行
            re.compile(r'^[^\w\s]*$'),  # 纯符号行
            re.compile(r'^页码?\s*\d+'),  # 页码
            re.compile(r'^第\s*\d+\s*页'),  # 页码（中文）
            re.compile(r'^\s*\d+\s*$'),  # 空白+数字
        ]
    
    def clean_text(self, text: str) -> Dict[str, any]:
        """清洗文本并返回详细结果"""
        original_length = len(text)
        
        # 1. 规范化空白符
        text = self._normalize_whitespace(text)
        
        # 2. 清理特殊字符
        text = self._clean_special_chars(text)
        
        # 3. 按行处理
        lines = text.split('\n')
        cleaned_lines = []
        lines_removed = 0
        
        for line in lines:
            cleaned_line = self._clean_line(line)
            if cleaned_line and self._is_valid_line(cleaned_line):
                cleaned_lines.append(cleaned_line)
            else:
                lines_removed += 1
        
        # 4. 移除重复行
        unique_lines = self._remove_duplicate_lines(cleaned_lines)
        
        # 5. 重新组合文本
        cleaned_text = '\n'.join(unique_lines)
        
        # 6. 计算质量评分
        quality_score = self._calculate_quality_score(cleaned_text)
        
        return {
            'cleaned_text': cleaned_text,
            'original_length': original_length,
            'cleaned_length': len(cleaned_text),
            'lines_removed': lines_removed,
            'compression_ratio': len(cleaned_text) / original_length if original_length > 0 else 0,
            'quality_score': quality_score
        }
    
    def _normalize_whitespace(self, text: str) -> str:
        """规范化空白符"""
        # 统一换行符
        text = re.sub(r'\r\n|\r', '\n', text)
        
        # 移除行尾空白
        text = re.sub(r'[ \t]+$', '', text, flags=re.MULTILINE)
        
        # 压缩多个空白符为单个空格
        text = re.sub(r'[ \t]+', ' ', text)
        
        # 压缩多个换行符
        text = re.sub(r'\n{3,}', '\n\n', text)
        
        return text.strip()
    
    def _clean_special_chars(self, text: str) -> str:
        """清理特殊字符"""
        # 清理常见的格式字符
        text = text.replace('…', '...')
        text = text.replace('—', '-')
        text = text.replace('–', '-')
        text = text.replace(''', "'")
        text = text.replace(''', "'")
        text = text.replace('