# Lesson 15：批量断点续传（工程化能力）

## 课次信息
- 时长：90 分钟
- 前置：Lesson 11–14（文本分块质量、批处理与容错、可溯源 QA、分层缓存）均已跑通，并具备基本评估能力。
- 后置：Lesson 16（增量更新与一致性），将复用本课的幂等键、检查点与失效策略。

## 教学目标（SMART）
- S：能在文档批处理场景中实现“可恢复的断点续传”，并提供可度量的吞吐、正确性与错误处理数据。
- M：在 100–1000 条文档的批处理中，故障注入（随机 1–5%）下的整体完成率 ≥ 99%，重复处理率 ≤ 1%，恢复时间 ≤ 1 分钟；具备可观测的检查点与命中率指标。
- A：在现有学生版 `document_processor` 的基础上，独立完成端到端示例（含输入/输出/错误路径）。
- R：服务课程主线的工程化能力（可靠性、可恢复性、可观测性），与后续增量更新、缓存失效的契约一致。
- T：90 分钟内完成并通过验收（含现场演示与提交物检查）。

## 教学重点
- 批处理设计：分批窗口、任务切分、分块边界与线程/协程并发。
- 断点续传：检查点（offset/marker）、任务状态机（pending/processing/done/failed）与恢复策略。
- 幂等键：来源唯一性、输入规范化与去重（exactly-once 目标下的 at-least-once 落地策略）。
- 重试与退避：指数退避、最大重试次数、失败降级与不阻塞主流程。
- 可观测性：处理进度、失败原因分布、重复率、恢复耗时、吞吐与延迟。

## 教学难点
- 一致性与重复处理：并发与失败场景下保证“可接受的一致性”与低重复率。
- 锁与竞争条件：批量场景中的共享检查点更新，避免热点与雪崩。
- 边界控制：分块边界不跨线程、长尾任务的饥饿与抢占。
- 失效与恢复：缓存/索引/存储的层级失效与对应的恢复顺序。

## 知识点详解
1) 检查点与状态机：
   - 检查点类型：全局 offset、基于对象的 marker、分片级（chunk-level）进度。
   - 状态机：`pending → processing → done | failed`，失败进入重试队列或降级路径。
2) 幂等键设计：
   - 键构成：`source + normalized_id + content_hash + layer`；避免仅用自增 ID。
   - 写入策略：幂等写（覆盖 vs 合并），记录 `attempts` 与 `last_error`。
3) 重试与退避：
   - 指数退避：`base_delay * (2 ** attempts) + jitter`；最大重试次数与熔断。
   - 失败降级：简化处理（清洗+固定分块）以保证收敛，后续标记待补。
4) 并发与边界约束：
   - 文档级并发，分块内同步；避免跨块边界并发导致上下文污染。
5) 可观测性与指标：
   - 指标：`throughput(doc/min)`, `latency(p50/p95)`, `fail_rate`, `dup_rate`, `resume_time`。
   - 日志与统计：分类失败原因、进度条输出、恢复点记录与导出。

## 完整示例与演示
- 输入示例：参见 `examples/input_example.json`（包含 100+ 文档 ID，混合大小与内容）。
- 期望输出：
  - 首次运行：处理完成数、失败与重试统计；生成检查点（例如 `checkpoint:{batch_id}`）。
  - 故障注入后重跑：从检查点恢复，仅处理未完成文档；重复率 ≤ 1%。
- 异常与兜底：
  - 400（客户端）：参数缺失/格式错误；返回统一错误结构 `{ error: { code/message/details/hints } }`。
  - 500（服务端）：解析失败/外部服务不可用；进入重试或降级路径，记录 `last_error`。

## 授课老师指导（时间轴）
- 导入（10’）：目标、产物与指标；对齐课程主线与契约。
- 讲解（25’）：检查点、幂等键、重试退避与并发边界；错误路径与兜底。
- 实践（40’）：
  - 运行批处理示例，展示首次与恢复运行的差异（命令与日志）。
  - 注入故障（模拟解析失败/外部服务超时）并观察指标与恢复时间。
- 总结（15’）：指标复盘与提交物检查，列出常见误区与改正策略。

### 教师讲稿（可直接照读）
- 开场：今天的核心是“可靠的批处理 + 可恢复的断点续传”，交付可观测的指标与一致性检查。
- 术语：检查点（checkpoint）、幂等（idempotency）、重试与退避、exactly-once 与 at-least-once。
- 示例：输入/输出/错误码；如何验证重复率与恢复时间；如何阅读统计与日志。
- 一致性：字段命名与错误结构统一；与后续（增量更新）对齐的失效与恢复约定。

### 课堂提问与练习（含参考答案）
- 问：为什么在工程实践中常选 at-least-once + 幂等而不是严格 exactly-once？
  - 答：复杂度与开销更低，结合幂等键与去重可达“工程上可接受”的一致性。
- 问：检查点应放在何处？如何避免热点？
  - 答：分层命名空间、批次分片与抖动；必要时引入局部锁/租约。
- 练习：在文档解析阶段注入 3% 的失败，观察重试与降级后的完成率与耗时。

## 黑板/投屏操作步骤（逐步）
1. 展示 `examples/input_example.json` 的批量输入结构与关键字段。
2. 运行批处理：展示日志中的进度、失败与重试记录（含检查点写入）。
3. 模拟故障：临时提高失败概率或断开外部模型，观察恢复策略与指标变化。
4. 再次运行：演示从检查点恢复（只处理未完成项），核对重复率与用时。
5. 打开 `checklist.md`：逐条对照验收标准并现场勾选。

## 学生任务
- 在 `labs/student/lab03/src/services/document_processor.py` 的 `process_documents_batch` 中：
  - 实现检查点持久化与恢复（支持 `batch_id` 与分片标识）。
  - 实现幂等键（来源+规范化 ID+内容哈希），避免重复处理。
  - 引入重试与退避（最大次数、抖动）、失败降级与统计输出。
  - 输出进度与指标：完成数、失败数、重复率、吞吐与恢复时间。
- 编写 100+ 文档的批量实验，注入 1–5% 随机失败，提交评估数据与截图。

## 对齐与连续性
- 与课程主线契约对齐：错误结构、字段命名与统计口径一致。
- 承接 Lesson 11–14 的并发与缓存策略；引出 Lesson 16 的增量更新与失效方案。

## 提交与验收
- 评估指标（建议阈值）：
  - 完成率 ≥ 99%，重复率 ≤ 1%，失败率 ≤ 5%，恢复时间 ≤ 1 分钟。
  - 吞吐与延迟：给出 p50/p95；并附日志与统计截图。
- 验收流程：
  - 运行两次（首次与恢复），核对检查点有效与重复率指标。
  - 查看统一错误结构与分类统计是否齐备；检查降级是否生效。

## 术语与概念定义
- 检查点（checkpoint）：记录处理进度的持久化标记（offset/marker）。
- 幂等（idempotency）：多次执行结果一致，通过键与去重保证工程上可接受的一致性。
- exactly-once / at-least-once：一次且仅一次 / 至少一次的投递语义与工程取舍。
- 指数退避（exponential backoff）：失败后按指数增加等待时间并加抖动。

## 提交前检查清单（教师/学生）
- 三要素齐备：目标/重点/难点明确且可测量。
- 示例完整：包含输入/输出/异常与兜底；错误结构统一。
- 教师指导可执行：时间轴与话术明确；黑板步骤可复现。
- 一致性：字段命名与指标口径统一；与主线契约对齐。
- 验收阈值：达标且可验证（含截图与日志）。

## 边界声明
- 不覆盖分布式队列、跨进程锁与强事务一致性的深度实现；若需，引导至后续扩展课程与参考文档。

---

导航与配套材料（与 lecture-best-practices.md 对齐）：
- 教师讲稿：`./teacher-script.md`（照读脚本，含时间轴与话术）
- 黑板/投屏步骤：`./blackboard-steps.md`（逐步演示与检查点）
- 提交前检查清单：`./checklist.md`（验收阈值与一致性核对）
- 示例与模板：`./examples/`（输入示例）、`./templates/`（提交模板）