# 第九节课：元数据过滤 - 教师讲义

## 课程信息
- **课程时长**：45分钟
- **理论讲解**：15分钟
- **演示操作**：15分钟  
- **学生实验**：15分钟
- **课程目标**：基于文档元数据进行检索过滤，提高检索精度

## 1. 课程概述（2分钟）

### 1.1 什么是元数据过滤
元数据过滤是在检索过程中，基于文档的结构化信息（如作者、分类、创建时间、标签等）进行筛选，从而提高检索结果的精确度和相关性。

### 1.2 为什么需要元数据过滤
- **提高精度**：通过预筛选减少无关结果
- **用户体验**：支持更精确的查询需求
- **性能优化**：减少需要处理的文档数量
- **业务逻辑**：支持权限控制、时间范围等业务需求

## 2. 技术原理（8分钟）

### 2.1 元数据类型
```
常见元数据字段：
- category: 文档分类（AI、技术、商业等）
- author: 作者信息
- created_at: 创建时间
- updated_at: 更新时间
- tags: 标签列表
- department: 部门信息
- access_level: 访问权限级别
```

### 2.2 查询条件类型
- **精确匹配**：category = "AI"
- **范围查询**：created_at BETWEEN '2024-01-01' AND '2024-12-31'
- **包含查询**：tags CONTAINS "机器学习"
- **复合条件**：多个条件的AND/OR组合

### 2.3 索引优化策略
- **单列索引**：为常用过滤字段创建索引
- **复合索引**：为常见查询组合创建复合索引
- **部分索引**：为特定条件创建部分索引
- **GIN索引**：为数组类型字段（如tags）创建GIN索引

## 3. 实现架构（5分钟）

### 3.1 数据库设计
```sql
-- 扩展documents表，添加元数据字段
ALTER TABLE documents ADD COLUMN category VARCHAR(50);
ALTER TABLE documents ADD COLUMN author VARCHAR(100);
ALTER TABLE documents ADD COLUMN created_at TIMESTAMP DEFAULT NOW();
ALTER TABLE documents ADD COLUMN tags TEXT[];
ALTER TABLE documents ADD COLUMN department VARCHAR(50);

-- 创建索引
CREATE INDEX idx_documents_category ON documents(category);
CREATE INDEX idx_documents_author ON documents(author);
CREATE INDEX idx_documents_created_at ON documents(created_at);
CREATE INDEX idx_documents_tags ON documents USING GIN(tags);
```

### 3.2 查询构建器
```python
class MetadataFilter:
    def __init__(self):
        self.conditions = []
        self.params = {}
    
    def add_condition(self, field, operator, value):
        # 动态构建查询条件
        pass
    
    def build_query(self, base_query):
        # 将过滤条件添加到基础查询中
        pass
```

## 4. 演示操作（15分钟）

### 4.1 数据库扩展演示
1. 连接PostgreSQL数据库
2. 执行ALTER TABLE语句添加元数据字段
3. 创建相应索引
4. 插入测试数据

### 4.2 元数据过滤服务演示
1. 展示MetadataFilterService类的实现
2. 演示不同类型的过滤条件
3. 展示查询性能对比（有索引vs无索引）
4. 演示复合查询条件的构建

### 4.3 API接口演示
1. 展示/rag/query接口的元数据过滤参数
2. 演示不同过滤条件的查询结果
3. 展示查询性能监控

## 5. 关键技术点

### 5.1 动态查询构建
- 使用参数化查询防止SQL注入
- 支持灵活的条件组合
- 处理空值和边界情况

### 5.2 性能优化
- 合理使用索引
- 查询计划分析
- 缓存常用查询结果

### 5.3 查询监控
- 记录查询执行时间
- 监控索引使用情况
- 分析慢查询

## 6. 常见问题与解决方案

### 6.1 性能问题
- **问题**：复杂过滤条件导致查询缓慢
- **解决**：创建复合索引，优化查询顺序

### 6.2 数据一致性
- **问题**：元数据更新不及时
- **解决**：建立元数据更新机制

### 6.3 查询复杂度
- **问题**：过滤条件过于复杂
- **解决**：提供查询构建器，简化条件组合

## 7. 课程总结

### 7.1 核心要点
1. 元数据过滤可以显著提高检索精度
2. 合理的索引设计是性能关键
3. 动态查询构建需要考虑安全性
4. 查询性能监控有助于持续优化

### 7.2 下节课预告
下节课将学习重排序(Rerank)接入，通过集成重排序模型进一步提升检索精度。

## 8. 思考题
1. 元数据过滤如何影响检索召回率？
2. 如何在大规模数据中保持过滤查询性能？
3. 如何设计元数据字段以平衡查询灵活性和性能？
4. 在什么情况下应该使用复合索引而不是单列索引？