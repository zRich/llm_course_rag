# Lesson 20 教师讲稿：故障注入与恢复演练

本讲稿面向教师，提供时间轴、话术与演示步骤，强调错误结构统一、指标与恢复能力的可观测与可复现。

## 时间轴（45 分钟）
- 0:00–3:00 开场与学习目标（SMART）
- 3:00–10:00 核心术语与故障类型
- 10:00–20:00 架构与实现（注入器、重试、熔断、告警）
- 20:00–35:00 端到端演示（多故障场景 → 恢复 → 指标）
- 35:00–41:00 混沌工程演练与防护边界
- 41:00–45:00 提问互动与总结、提交要求强调

## 开场话术（示例）
可靠性来自“被验证的恢复能力”。我们要在安全的演示环境中主动制造故障，观察系统的退避重试、熔断保护与降级，并以指标证明弹性：错误率、MTTR、重试成功率与错误预算消耗。

## 核心术语与定义
- 故障注入（Fault Injection）：主动引入故障以验证容错与恢复。
- 重试与退避（Retry/Backoff）：指数/线性退避控制重试节奏。
- 熔断器（Circuit Breaker）：失败达阈值时短路，半开试探恢复。
- 错误预算（Error Budget）：在一段时间内可接受错误的额度。
- MTTR：平均恢复时间，从故障到恢复的平均耗时。

## 架构与实现要点
- 注入器：故障类型（429/超时/500/数据损坏），可配置频率与目标模块。
- 恢复机制：退避重试、限流、熔断、降级；幂等与检查点保护写入侧。
- 监控告警：错误率、响应时间、熔断触发、降级使用率；阈值与告警动作。
- 错误结构统一：`{ error: { code, message, details, hints } }`。

## 端到端演示步骤与话术
1) 打开 `examples/fault_plan.json`，讲解故障类型、频率、持续时间与目标组件。
2) 运行注入与恢复：展示日志中重试/退避、熔断开启/半开尝试、降级响应。
3) 指标面板：错误率曲线、MTTR 统计、熔断触发次数、降级使用率。
4) 失败兜底：在写入侧依赖幂等键与检查点，避免重复与丢失。

## 混沌工程演练
- 组合故障：并发注入网络超时与外部服务 500；验证熔断保护范围与恢复路径。
- 边界声明：严格限定注入范围与数据域，避免影响真实生产数据。

## 课堂提问与互动
- 哪些故障适合重试，哪些应该立即失败？
- 熔断恢复策略如何选择半开调用数与超时时间？
- 如何设定错误预算与告警阈值以避免告警风暴？

## 总结话术
恢复能力必须通过演练与指标证明。工程化的可靠性是（注入 → 观测 → 恢复 → 复盘）的闭环。

## 提交要求与验收复盘（与 checklist 对齐）
- 文档齐备：README、teacher-script、blackboard-steps、checklist、examples、templates。
- 覆盖场景：至少三类故障；含组合故障演练。
- 指标达成：错误率、MTTR、重试成功率、熔断触发次数与降级使用率。
- 报告与证据：日志片段与截图；阈值配置与复盘总结。