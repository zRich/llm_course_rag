# Lesson 11：Chunk 尺寸与重叠实验

## 课次信息
- 时长：90 分钟
- 前置：Lesson 10（已具备混合检索与重排能力；拥有可检索数据集）
- 后置：Lesson 14（将复用本课的最佳尺寸与重叠策略，进入缓存策略与命中率优化）

## 教学目标（SMART）
- S：能在检索系统中正确设置并评估 Chunk 尺寸与重叠策略，对比至少 3 组配置，并形成结论与提交物。
- M：完成 3 组以上配置的端到端验证；提供可重复的调用日志与指标表；检索 `total_found` ≥ 1，问答成功率提升或保持稳定；错误率 ≤ 5%。
- A：在 90 分钟内，独立完成配置、向量化、检索、问答与记录，提交标准化报告。
- R：与模块目标一致，为后续缓存优化与召回提升提供基础参数选择。
- T：90 分钟内完成并验收。

## 教学重点
- Chunk 尺寸（`CHUNK_SIZE`）与重叠（`CHUNK_OVERLAP`）的作用与权衡。
- 不同配置对分块数、检索召回、上下文连贯性与问答质量的影响。
- 实验设计与可测量指标：分块统计、检索指标、问答质量与错误路径。

## 教学难点
- 配置更改后的全链路重建与验证（重向量化、索引刷新）。
- 评估口径的统一与不可虚构声明（指标必须可复核）。
- 中文语料下的分块边界与句子连续性对问答影响的理解。

## 知识点详解
1) Chunk 尺寸与重叠的概念与影响（输入/输出/错误路径）
- 输入：环境变量或配置项 `CHUNK_SIZE`、`CHUNK_OVERLAP`。
- 输出：分块集合（`chunk_id/document_id/chunk_index/content/token_count/char_count/start_position/end_position`）。
- 影响：分块数目、上下文覆盖范围、检索与问答质量（过小影响语义完整，过大影响匹配与向量质量）。
- 错误：`CHUNK_SIZE<=0` 或 `CHUNK_OVERLAP<0`，应拒绝并返回统一错误结构。

2) 实验设计方法（概念解释与示例）
- 选择至少 3 组配置（示例：`(600,100)`, `(1000,200)`, `(1500,300)`）。
- 对固定数据集依次进行：分块 → 向量化 → 检索 → 问答评估。
- 记录：分块统计、检索 `total_found`、上下文长度与命中片段、问答正确性与引用质量。

## 完整示例与演示
- 输入（配置与请求）示例：
```
# .env（片段）
CHUNK_SIZE=1000
CHUNK_OVERLAP=200
```
```
POST /api/v1/retrieval/search
{
  "query": "RAG系统",
  "top_k": 6,
  "score_threshold": 0.2,
  "fusion": {"strategy": "rrf", "k": 60},
  "rerank_top_m": 6
}
```
- 期望输出（片段）：
```
{
  "success": true,
  "query": "RAG系统",
  "total_found": 5,
  "results": [
    {
      "chunk_id": "...",
      "document_id": "...",
      "document_filename": "test_document.txt",
      "chunk_index": 3,
      "content": "...",
      "score": 0.73,
      "start_position": 1200,
      "end_position": 2200,
      "metadata": {"page": 3}
    }
  ]
}
```
- 异常与兜底（错误处理统一结构）：
```
{
  "error": {
    "code": 400,
    "message": "非法的 CHUNK_SIZE",
    "details": {"chunk_size": -1},
    "hints": ["请设置为正整数", "建议范围 600..1500"]
  }
}
```

## 授课老师指导
- 时间轴与脚本：
  - 导入（10 分钟）：概念与目标、评估维度介绍。
  - 讲解（20 分钟）：分块策略作用、中文场景注意事项。
  - 实践（45 分钟）：三组配置的端到端实验，记录并对照。
  - 总结（15 分钟）：收敛到推荐区间与边界声明。
- 提问与互动：
  - 为什么过大 `CHUNK_SIZE` 可能降低检索命中？
  - 如何选择 `CHUNK_OVERLAP` 以平衡上下文连续性与冗余？

### 教师讲稿（可直接照读）
- 开场：本课目标是找到适合中文检索与问答的分块尺寸与重叠配置，通过端到端实验，形成依据充分的结论与提交报告。
- 术语：Chunk、Overlap、Token/Char Count、Recall/Total Found、Context Window。
- 示例：展示不同配置下的分块统计、检索结果与问答来源对比；强调错误路径与兜底策略。
- 一致性：字段命名（`chunk_id/document_id/chunk_index/...`）与错误结构统一。

### 课堂提问与练习（含参考答案）
- 提问：`CHUNK_SIZE` 增大是否一定提高问答质量？（答：不一定，存在语义冗余与向量质量稀释的权衡）
- 提问：`CHUNK_OVERLAP` 的作用是什么？（答：保证跨块语义连续性，对召回和上下文构建有帮助，但过大带来冗余）
- 练习：选择两组配置，比较检索 `total_found` 与问答来源段落的覆盖差异，写出结论。

### 常见误区与应对话术
- 误区：只看 `total_found` 不看来源质量。→ 强调引用的文本块是否与答案一致。
- 误区：忽略重向量化与索引刷新。→ 修改配置后必须重跑向量化。
- 误区：中文断句与段落边界忽略。→ 展示文本分割器的边界策略。

### 黑板/投屏操作步骤（逐步）
1. 展示 `.env` 中 `CHUNK_SIZE/CHUNK_OVERLAP` 与推荐区间。
2. 现场执行：文档上传 → 向量化 → 检索 → 问答。
3. 展示检索响应的字段与错误结构，做一致性检查。
4. 演示提交模板填写与截图/日志的收集方式。

## 学生任务
- 课堂任务：完成三组配置的端到端验证，填写模板并现场提交草稿。
- 课后任务：补充实验数据与结论，完善报告并提交 PR。

## 对齐与连续性
- 与 Module（RAG 检索与问答）的锚点：分块影响检索召回与问答质量。
- 承接 Lesson 10 的能力：可在有/无重排的两种条件下比较排序与命中。
- 引出 Lesson 14：基于稳定配置开展缓存策略与命中率优化。

## 提交与验收
- 评估标准：
  - 配置组数 ≥ 3；每组均有分块统计、检索与问答日志。
  - 指标表完整：分块数、平均 token/char、`total_found`、问答来源命中率。
  - 错误路径与兜底：至少 1 条错误示例（非法配置或服务异常）。
- 验收标准：
  - 响应与字段命名一致；日志与截图真实可复核（不可虚构）。
  - 结论明确且基于数据（推荐区间与理由）。

## 边界声明
- 本课不覆盖：嵌入模型更换、分块的深度语言学切分策略（如语法树）。
- 外部依赖：Postgres/Qdrant/Redis 正常可用；若不可用，需先恢复服务。

---

- 相关文件：
  - `teacher-script.md`（讲稿与时间轴）
  - `blackboard-steps.md`（黑板/投屏步骤）
  - `checklist.md`（提交前检查清单）
  - `examples/`（输入与错误响应示例）
  - `templates/`（提交模板）