# Lesson 17 教师讲稿：结构化数据接入与一致性

本讲稿面向授课教师，提供从开场、术语、架构讲解到端到端演示与课堂互动的完整话术与操作要点。与 lecture-best-practices 对齐，聚焦“稳、准、可观测”的工程化能力。

## 时间轴（45 分钟）
- 0:00–3:00 开场与学习目标（SMART）
- 3:00–10:00 核心术语与一致性要点
- 10:00–20:00 架构与实现（连接器、映射、增量键、CDC、幂等）
- 20:00–35:00 端到端演示（API/DB/CSV → 标准文档 → RAG）
- 35:00–41:00 故障注入与恢复演示（速率限制/网络抖动/模式变更）
- 41:00–45:00 提问互动与总结、提交要求强调

## 开场话术（示例）
今天我们聚焦“结构化数据接入”。目标是把来自 API、数据库、文件等来源的结构化数据，稳定、可控地接入到 RAG 系统，并保证增量更新的正确性与幂等性。课后你需要能独立配置连接器、定义字段映射、设计增量键与检查点，并用指标证明接入的质量与一致性。

## 核心术语与定义
- 数据连接器（Data Connector）：抽象不同数据源（API/DB/File）的统一接口。
- 字段映射（Field Mapping）：将源表/响应字段映射到标准文档字段（title/body/metadata）。
- 增量键（Incremental Key）：用于追踪变更（如 `updated_at`、自增版本号或 CDC 序列号）。
- 变更数据捕获（CDC）：捕获插入/更新/删除事件流以实现实时或准实时同步。
- 幂等键（Idempotency Key）：确保重复写入不产生副作用（通常由 `namespace + primary_key + version` 组合）。
- 一致性（Consistency）：对外可感知的状态与内部存储一致；包含最终一致与强一致的权衡。

## 架构与实现要点
- 连接器层：APIConnector、DatabaseConnector、FileConnector；负责连接、分页、速率限制、重试。
- 标准化与转换层：统一数据结构、清洗异常值、字段映射、类型转换。
- 增量与检查点：基于增量键或 CDC 偏移量；检查点持久化于 KV/DB；支持断点续传。
- 幂等与合并策略：写入前构造幂等键；对更新与删除事件实现安全合并。
- 并发边界与节流：控制并发抓取与写入；为热点数据源配置速率限制与退避。
- 可观测性：拉通接入端到端的计数器、耗时、失败原因、重复写入拦截数。

## 端到端演示步骤与话术
1) 场景设定：来自 PostgreSQL `users` 表与订单 API `orders` 的数据合并到 RAG 文档库。
2) 展示 `examples/input_structured.json`：包含连接器配置、字段映射、增量键与并发参数。
3) 首次全量接入：观察日志中的批次大小、写入速率与成功/失败计数。
4) 增量更新：模拟新增用户/订单更新；仅增量被抓取与更新，重复写入被幂等拦截。
5) 故障注入：
   - 速率限制（429/限流）：展示指数退避与配额恢复。
   - 网络抖动：展示重试与检查点保护。
   - 模式变更（新增列）：展示字段映射的版本化与兼容策略。
6) 恢复与复盘：再次运行，验证断点续传生效；对照指标面板给出达成度。

## 课堂提问与互动
- 为什么需要幂等键？在哪些位置构造最合适？
- 增量键为时间戳 vs 序列号两种策略的优缺点？
- 如何在并发抓取下保证落库顺序与一致性？
- 当源端发生模式变更时，如何避免大面积重建？

## 总结话术
结构化数据接入的本质是稳定、可观测的系统整合。关键在连接器抽象、字段映射、增量与幂等、并发控制与日志指标。工程化能力的衡量标准是可复现的流程、明确的指标与可解释的失败。

## 提交要求与验收复盘（与 checklist 对齐）
- 文档齐备：README、teacher-script、blackboard-steps、checklist、examples、templates。
- 实现一致性：增量键正确、幂等写入生效、检查点可复现。
- 指标达成：覆盖率、重复拦截率、失败重试成功率、端到端耗时。
- 报告与证据：运行日志、截图、配置、对比数据、复盘总结。