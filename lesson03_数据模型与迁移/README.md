# Lesson 03：数据模型与迁移

## 课次信息
- **课次编号**: Lesson 03
- **模块编号**: Module 02 - 核心系统构建
- **预计时长**: 2小时（120分钟）
- **前置依赖**: Lesson 02（容器化环境已搭建，PostgreSQL服务已启动）
- **后置依赖**: Lesson 04（将复用数据模型进行API开发）

## 教学目标（SMART）
- **S（具体）**: 能在RAG系统中正确设计用户、文档、向量等数据模型，并使用SQLModel和Alembic完成数据库迁移
- **M（可测量）**: 数据模型设计覆盖率 ≥ 90%；迁移脚本执行成功率 ≥ 95%；代码规范符合率 ≥ 85%
- **A（可达成）**: 在限定时间与工具内，独立完成端到端的数据模型设计与迁移
- **R（相关性）**: 与模块目标一致，服务RAG系统核心数据架构构建
- **T（时限性）**: 120分钟内完成并验收

## 教学重点
- SQLModel核心概念与使用方法
- PostgreSQL数据库连接与配置
- 数据模型设计原则与最佳实践
- Alembic数据迁移系统的使用

## 教学难点
- SQLModel与Pydantic的关系理解
- 数据库关系映射的复杂性
- 迁移脚本的版本控制与回滚机制
- 向量数据存储的特殊处理

## 学生任务

### 课堂任务
1. **Exercise 1: SQLModel基础模型设计** - 设计用户和文档基础模型
2. **Exercise 2: 数据库连接配置** - 配置PostgreSQL连接池
3. **Exercise 3: 关系模型设计** - 实现用户-文档关联关系
4. **Exercise 4: 迁移脚本编写** - 使用Alembic创建和执行迁移

### 课后任务
- **Lab 03: RAG系统完整数据模型** - 设计包含向量存储的完整数据架构

### 扩展Exercise
- 性能优化：索引设计与查询优化
- 数据安全：敏感信息加密存储

## 对齐与连续性

### 承接上一课
- 复用Lesson 02搭建的PostgreSQL容器环境
- 基于已有的项目结构进行数据层开发
- 使用已配置的开发环境和依赖管理

### 引出下一课
- 为Lesson 04的API开发提供数据模型基础
- 建立数据访问层的接口规范
- 准备用户认证和文档管理的数据支撑

## 提交与验收

### 评估标准
1. **功能完整性（40%）**
   - 数据模型定义完整且符合业务需求
   - 数据库连接配置正确
   - 迁移脚本能够成功执行

2. **代码质量（30%）**
   - 代码结构清晰，符合Python规范
   - 类型注解完整，字段定义准确
   - 错误处理机制完善

3. **文档质量（20%）**
   - 模型设计说明清晰
   - 迁移步骤记录完整
   - 问题解决过程有记录

4. **创新性（10%）**
   - 数据模型设计的优化思考
   - 性能优化的实践尝试

### 提交要求
- 项目目录：`rag-system/`
- 必需文件：
  - `src/models/` - 数据模型定义
  - `src/database/` - 数据库配置
  - `migrations/` - 迁移脚本
  - `alembic.ini` - Alembic配置
- 可选文件：
  - `docs/database-design.md` - 数据库设计文档
  - `tests/test_models.py` - 模型测试

### 验收流程
1. 代码结构检查
2. 数据模型验证
3. 迁移脚本测试
4. 数据库连接测试
5. 文档完整性检查

## 术语与概念定义

### 核心概念
- **SQLModel**: FastAPI作者开发的现代Python SQL工具包，结合了Pydantic和SQLAlchemy的优点
- **ORM**: 对象关系映射，将数据库表映射为Python类
- **数据迁移**: 数据库结构变更的版本控制和自动化执行
- **连接池**: 数据库连接的复用机制，提高性能和资源利用率

### 技术术语
- **Alembic**: SQLAlchemy的数据库迁移工具
- **PostgreSQL**: 开源的关系型数据库管理系统
- **UUID**: 通用唯一标识符，用于主键设计
- **索引**: 数据库查询优化的重要机制

## 边界声明

### 本课解决的问题
- 数据模型的基础设计与实现
- 数据库连接的配置与管理
- 基本的数据迁移操作

### 本课不解决的问题
- 复杂的数据库性能调优
- 分布式数据库架构设计
- 高级的数据安全策略
- 大规模数据迁移的优化

### 外部依赖
- PostgreSQL数据库服务
- Python开发环境
- SQLModel和Alembic库

### 替代方案
- 可使用其他ORM框架（如Django ORM、Peewee）
- 可选择其他数据库（如MySQL、SQLite）
- 可使用其他迁移工具（如Django migrations）