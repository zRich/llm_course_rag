实验 4 学生任务说明（对应课程 15–18）

概述
- 本实验以“批量接入与增量更新”为核心，分四个课时任务：
  - 课程15：断点续传与幂等管道
  - 课程16：三类数据源连接器（CSV / SQL / API）
  - 课程17：结构化规范化与文本清洗
  - 课程18：增量更新与失效重建
- 学生代码已插入 TODO 占位，完成后应满足接口可用与验证清单通过。
- 遵循最佳实践：`lab-best-practices.md`（命名规范、最小可运行、可测试、类型标注、错误处理）。

课程15：断点续传与幂等管道
- 文件：`src/services/ingestion.py`
  - `CheckpointManager.load/save/mark`
    - 从/写入缓存，序列化 `Checkpoint`，合理处理异常与 TTL。
  - `idempotency_key(doc, stable_fields)`
    - 按稳定字段拼接计算 `SHA256` 幂等键。
  - `DocumentSink.exists(key)`
    - 通过 `content_hash` 或 `metadata_` 中的 `idempotency_key` 判断重复。
  - `DocumentSink.write(key, doc)`
    - 清洗文本，写入 `Document`，分块写入 `Chunk`，更新统计与状态。
  - `BatchResumableLoader.run(pipeline_id, docs, chunk_size)`
    - 恢复偏移，按批大小处理；生成幂等键，存在跳过；更新检查点。

课程16：数据源连接器（CSV/SQL/API）
- 文件：
  - `src/connectors/csv_connector.py` → `load_csv(file_path, field_mapping)`
  - `src/connectors/sql_connector.py` → `fetch_sql(db_uri, query, field_mapping)`
  - `src/connectors/api_connector.py` → `fetch_api(url, headers, params, path, field_mapping)`
- 要点：
  - 读取数据并按映射抽取 `{id,title,content,tags,source}` 统一结构。
  - CSV 标签支持分号分隔；SQL 使用 `rs.mappings()`；API 支持嵌套路径如 `data.items`。
  - 正确处理异常，避免影响上层管道。

课程17：结构化与清洗
- 文件：
  - `src/services/ingestion.py` → `make_structured_docs(raws)`
  - `src/services/cleaning.py` → `CleaningService.clean_text(text)`
- 要点：
  - 规范化 `id/title/content/tags/source` 字段，去除空白并类型稳定。
  - 文本清洗：统一换行与空格、去除行首尾空白、删除空行。

课程18：增量更新与重建
- 文件：`src/services/incremental.py`
  - `IncrementalService.upsert_document(doc_id, title, content, metadata)`
    - 清洗新内容，计算哈希，未变化跳过；更新后调用重建。
  - `IncrementalService.rebuild_document(doc_id)`
    - 删除旧分块，按策略分块并写入，更新统计与状态。

接口与验证
- 路由：`src/api/routes/ingestion.py`
  - `/ingestion/csv|sql|api` 批量接入（依赖课程15–17实现）
  - `/ingestion/run` 通用批量运行（依赖课程15–17实现）
  - `/ingestion/checkpoint/{pipeline_id}` 检查点查询（课程15）
  - `/ingestion/incremental/upsert|rebuild` 增量更新与重建（课程18）

验收标准（示例）
- 课程15：断点续传相同批次多次运行不重复写入；中断后可继续。
- 课程16：三类连接器返回统一结构；异常被吞吐并记录。
- 课程17：清洗前后文本差异符合预期；规范化容错字段缺失。
- 课程18：内容不变跳过；变化后统计与分块数更新正确。

提示与建议
- 为每个 TODO 编写最小单元测试或接口调用用例。
- 注意 `metadata_` JSON 序列化与中文字符处理（`ensure_ascii=False`）。
- 在开发环境使用 `uv run uvicorn src.main:app --reload` 启动并调试。

完成提交
- 移除所有 `NotImplementedError` 与 `TODO(lab04-lessonXX)` 注释。
- 确保接口可运行、测试通过，并在 README 中补充说明实现与验证方法。