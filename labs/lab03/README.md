# 实验3：系统性能优化实验（Lesson 11-14)

## 实验概述

本实验专注系统性能、吞吐与可溯源体验的提升，严格覆盖课程第 11-14 课：分块（Chunk）尺寸与重叠实验、多文档源并行处理、引用与可溯源输出、缓存策略。实验以“实验2 的候选集合与评估脚本”为输入，在不改变检索与重排逻辑的前提下优化整体性能与可观测性。

> 边界与对齐：不包含 Lesson 7-10 的检索优化、融合、过滤与重排序工作；如需调整候选生成或评分，请回到实验2完成，并将结果作为本实验输入。

## 涉及课程
- Lesson 11：Chunk 尺寸与重叠实验
- Lesson 12：多文档源处理与并行架构
- Lesson 13：引用与可溯源输出
- Lesson 14：缓存策略与命中率优化

## 实验目标
- 找到不同文档类型的最佳分块参数组合（尺寸、重叠与策略）
- 设计可扩展的多源并行处理管线，具备容错与重试能力
- 为生成答案构建引用链路与可信度评估，提升可溯源性
- 设计多层缓存与命中策略，降低端到端延迟并稳定性能
- 建立可观测性与统一评估，形成可复现实验结论

## 技术栈
- 异步与并行：`asyncio`、`aiohttp`、`ThreadPoolExecutor`
- 缓存系统：`Redis`（含 TTL/LRU/LFU）、本地内存缓存
- 监控与埋点：`Prometheus`、`Grafana`、`logging`、`tracing`
- 继承：沿用实验1/2 的数据层与评估脚本（不改检索逻辑）

## 前置条件
- 已完成实验1与实验2，并产出候选集与评估脚本
- 准备至少 3 种不同类型文档（技术文档/法规条文/FAQ）
- 明确实验2的查询集与指标口径（`nDCG@10`、`MRR@10`、延迟）

## 实验步骤（建议分阶段实施）

### 阶段 1：分块策略优化（Lesson 11）
- 对比固定、语义与句级分块三类策略，不同尺寸与重叠组合
- 指标：分块时间、索引构建时间、检索指标（以实验2候选评估）
- 结论：按文档类型给出推荐参数表与取舍分析

### 阶段 2：多源并行处理（Lesson 12）
- 设计异步/并行管线，支持 PDF/HTML/API/DB 等多源摄取
- 引入限流、重试与降级策略，确保稳态吞吐与可用性
- 报告吞吐（docs/min）、平均延迟与失败率，并给出优化点

### 阶段 3：引用与可溯源输出（Lesson 13）
- 为 Top-K 结果构建引用与证据链，包含 `doc_id`、`chunk_id`、页码与置信度
- 评估引用准确率与覆盖率，给出与答案质量的关联分析
- 输出统一格式的可溯源答案（JSON/Markdown），便于集成前端

### 阶段 4：缓存策略与命中率优化（Lesson 14）
- 设计多层缓存（L1 内存、L2 Redis），定义键空间与 TTL
- 选择与评估策略：LRU/LFU/语义相似缓存；建立命中率与延迟曲线
- 讨论一致性与失效处理：主动失效、定期清理与写穿/读穿策略

### 阶段 5：性能评估与可观测性
- 建立统一埋点与仪表盘：请求量、延迟分布、错误率与缓存命中率
- 拉齐评估口径，与实验2共用查询集与统计方法，便于横向对比
- 形成复盘结论：在不改检索的前提下，端到端体验的提升幅度

## 实验任务（必须完成）
- 任务 A：完成 3 类分块策略的参数对比与结论产出
- 任务 B：实现多源并行管线，覆盖至少 3 种数据源并含容错
- 任务 C：实现可溯源输出，达到 ≥90% 引用准确率（抽样评估）
- 任务 D：实现多层缓存并报告命中率-延迟曲线与优化建议

## 评估指标与度量
- 吞吐与延迟：docs/min、p50/p95 延迟、错误率
- 引用质量：引用准确率、覆盖率与置信度分布
- 缓存效果：命中率、带缓存与不带缓存的延迟对比
- 资源利用：CPU/内存占用与稳定性（可选）

## 提交与验收
- 代码：异步/并行管线、引用输出与缓存实现，含配置与脚本
- 报告：结构化呈现实验设计、数据、结果与取舍（建议 Markdown）
- 指标：统一报告吞吐、延迟分布、缓存命中率与引用质量
- 复现：按 README 指令可在本地复现主要结论（±5% 误差）

## 常见问题与提示
- 并行并不总是更快：I/O 与 CPU 负载需分场景选型
- 语义分块可能影响可溯源定位；需在准确性与可读性间取舍
- 缓存键空间设计决定命中率与一致性风险；注意 TTL 与失效
- 指标口径必须与实验2一致，确保横向对比有效

## 参考与对齐
- 与实验2的接口约定与评估脚本保持一致
- Lesson 11-14 的课程材料与示例代码（按课程目录）