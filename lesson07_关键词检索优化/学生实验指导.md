# ç¬¬ä¸ƒè¯¾ï¼šå…³é”®è¯æ£€ç´¢ä¼˜åŒ– - å­¦ç”Ÿå®éªŒæŒ‡å¯¼

## ğŸ¯ å®éªŒç›®æ ‡

é€šè¿‡æœ¬å®éªŒï¼Œä½ å°†å­¦ä¼šï¼š
1. åœ¨lesson06åŸºç¡€ä¸Šæ·»åŠ PostgreSQLå…¨æ–‡æ£€ç´¢åŠŸèƒ½
2. ä½¿ç”¨jiebaè¿›è¡Œä¸­æ–‡åˆ†è¯å¤„ç†
3. å®ç°åŸºç¡€çš„å…³é”®è¯æœç´¢æ¥å£
4. ç†è§£å…³é”®è¯æ£€ç´¢ä¸å‘é‡æ£€ç´¢çš„åŒºåˆ«

**å®éªŒæ—¶é•¿**ï¼š15åˆ†é’Ÿ

---

## ğŸ“‹ ç¯å¢ƒå‡†å¤‡

### æ­¥éª¤1ï¼šåˆ‡æ¢åˆ°lesson07åˆ†æ”¯

```bash
# è¿›å…¥rag-systemé¡¹ç›®ç›®å½•
cd /Users/richzhao/dev/llm_courses/courses/8_llm_in_action/unit6_RAGå®æˆ˜/rag-system

# åˆ‡æ¢åˆ°lesson07åˆ†æ”¯ï¼ˆåŸºäºlesson06ï¼‰
git checkout lesson07

# éªŒè¯å½“å‰åˆ†æ”¯
git branch
# åº”è¯¥æ˜¾ç¤º * lesson07
```

### æ­¥éª¤2ï¼šå®‰è£…jiebaåˆ†è¯åº“

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å®‰è£…jieba
pip install jieba==0.42.1

# éªŒè¯å®‰è£…
python -c "import jieba; print('jiebaå®‰è£…æˆåŠŸ')"
```

---

## ğŸ”§ å®éªŒä¸€ï¼šæ•°æ®åº“æ‰©å±•ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1ï¼šæ·»åŠ å…¨æ–‡æ£€ç´¢å­—æ®µ

è¿æ¥åˆ°PostgreSQLæ•°æ®åº“ï¼š
```bash
# å¯åŠ¨æ•°æ®åº“æœåŠ¡ï¼ˆå¦‚æœæœªå¯åŠ¨ï¼‰
docker-compose up -d

# è¿æ¥æ•°æ®åº“
psql -h localhost -p 5432 -U rag_user -d rag_db
```

åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œï¼š
```sql
-- 1. æŸ¥çœ‹ç°æœ‰æ–‡æ¡£
SELECT id, title, LEFT(content, 50) as preview FROM documents LIMIT 3;

-- 2. æ·»åŠ å…¨æ–‡æ£€ç´¢å­—æ®µ
ALTER TABLE documents ADD COLUMN IF NOT EXISTS content_vector tsvector;

-- 3. æ›´æ–°ç°æœ‰æ•°æ®çš„å‘é‡å­—æ®µ
UPDATE documents 
SET content_vector = to_tsvector('simple', COALESCE(title, '') || ' ' || COALESCE(content, ''));

-- 4. åˆ›å»ºGINç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_content_vector ON documents USING gin(content_vector);

-- 5. éªŒè¯è®¾ç½®
SELECT id, title, content_vector FROM documents LIMIT 1;
```

---

## ğŸ”§ å®éªŒäºŒï¼šä¸­æ–‡åˆ†è¯æµ‹è¯•ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºåˆ†è¯æµ‹è¯•è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `test_jieba.py`ï¼š
```python
import jieba

def test_segmentation():
    """æµ‹è¯•jiebaåˆ†è¯æ•ˆæœ"""
    test_texts = [
        "äººå·¥æ™ºèƒ½å’Œæœºå™¨å­¦ä¹ ",
        "PostgreSQLæ•°æ®åº“å…¨æ–‡æ£€ç´¢",
        "RAGç³»ç»Ÿå‘é‡æ£€ç´¢æŠ€æœ¯"
    ]
    
    print("ğŸ” jiebaåˆ†è¯æµ‹è¯•")
    print("=" * 40)
    
    for i, text in enumerate(test_texts, 1):
        print(f"\næµ‹è¯• {i}: {text}")
        
        # ç²¾ç¡®æ¨¡å¼
        words1 = jieba.lcut(text)
        print(f"ç²¾ç¡®æ¨¡å¼: {' / '.join(words1)}")
        
        # æœç´¢æ¨¡å¼
        words2 = jieba.lcut_for_search(text)
        print(f"æœç´¢æ¨¡å¼: {' / '.join(words2)}")
        
        # ä¸ºPostgreSQLå‡†å¤‡çš„æ–‡æœ¬
        search_ready = ' '.join(words2)
        print(f"æœç´¢æ–‡æœ¬: {search_ready}")

if __name__ == "__main__":
    test_segmentation()
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
python test_jieba.py
```

---

## ğŸ”§ å®éªŒä¸‰ï¼šå…³é”®è¯æœç´¢å®ç°ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºæœç´¢å‡½æ•°

åˆ›å»ºæ–‡ä»¶ `keyword_search.py`ï¼š
```python
import jieba
import psycopg2
from typing import List, Dict

# æ•°æ®åº“è¿æ¥é…ç½®
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'rag_db',
    'user': 'rag_user',
    'password': 'rag_password'
}

def preprocess_query(query: str) -> str:
    """é¢„å¤„ç†æŸ¥è¯¢æ–‡æœ¬"""
    # ä½¿ç”¨jiebaåˆ†è¯
    words = jieba.lcut_for_search(query)
    
    # è¿‡æ»¤ç©ºè¯å’Œå•å­—ç¬¦
    filtered_words = [w.strip() for w in words if len(w.strip()) > 1]
    
    # æ„å»ºtsqueryæ ¼å¼
    if not filtered_words:
        return ''
    
    # ä½¿ç”¨ & è¿æ¥ï¼ˆANDæ“ä½œï¼‰
    tsquery_parts = [f"'{word}':*" for word in filtered_words]
    return ' & '.join(tsquery_parts)

def keyword_search(query: str, limit: int = 5) -> List[Dict]:
    """æ‰§è¡Œå…³é”®è¯æœç´¢"""
    # é¢„å¤„ç†æŸ¥è¯¢
    processed_query = preprocess_query(query)
    if not processed_query:
        return []
    
    # è¿æ¥æ•°æ®åº“
    conn = psycopg2.connect(**DB_CONFIG)
    cursor = conn.cursor()
    
    try:
        # æ‰§è¡Œæœç´¢
        sql = """
        SELECT 
            id, title, content,
            ts_rank(content_vector, to_tsquery('simple', %s)) as score
        FROM documents 
        WHERE content_vector @@ to_tsquery('simple', %s)
        ORDER BY score DESC
        LIMIT %s
        """
        
        cursor.execute(sql, (processed_query, processed_query, limit))
        results = cursor.fetchall()
        
        # æ ¼å¼åŒ–ç»“æœ
        formatted_results = []
        for row in results:
            formatted_results.append({
                'id': row[0],
                'title': row[1],
                'content': row[2][:200] + '...' if len(row[2]) > 200 else row[2],
                'score': round(row[3], 4)
            })
        
        return formatted_results
    
    finally:
        cursor.close()
        conn.close()

def test_search():
    """æµ‹è¯•æœç´¢åŠŸèƒ½"""
    test_queries = [
        "Python",
        "æ•°æ®åº“",
        "æœºå™¨å­¦ä¹ "
    ]
    
    print("ğŸ” å…³é”®è¯æœç´¢æµ‹è¯•")
    print("=" * 40)
    
    for query in test_queries:
        print(f"\næœç´¢: {query}")
        print("-" * 20)
        
        results = keyword_search(query, limit=3)
        
        if results:
            for i, result in enumerate(results, 1):
                print(f"{i}. [{result['score']}] {result['title']}")
                print(f"   {result['content'][:100]}...")
        else:
            print("   æ— æœç´¢ç»“æœ")

if __name__ == "__main__":
    test_search()
```

### æ­¥éª¤2ï¼šè¿è¡Œæœç´¢æµ‹è¯•

```bash
python keyword_search.py
```

---

## ğŸ“ å®éªŒéªŒè¯

### éªŒè¯æ¸…å•

- [ ] æˆåŠŸæ·»åŠ äº†content_vectorå­—æ®µ
- [ ] åˆ›å»ºäº†GINç´¢å¼•
- [ ] jiebaåˆ†è¯æ­£å¸¸å·¥ä½œ
- [ ] å…³é”®è¯æœç´¢è¿”å›ç»“æœ
- [ ] æœç´¢ç»“æœæŒ‰ç›¸å…³æ€§æ’åº

### æµ‹è¯•ä¸åŒæŸ¥è¯¢

åœ¨PostgreSQLä¸­ç›´æ¥æµ‹è¯•ï¼š
```sql
-- æµ‹è¯•1ï¼šè‹±æ–‡å…³é”®è¯
SELECT id, title, ts_rank(content_vector, to_tsquery('simple', 'python')) as score
FROM documents 
WHERE content_vector @@ to_tsquery('simple', 'python')
ORDER BY score DESC LIMIT 3;

-- æµ‹è¯•2ï¼šä¸­æ–‡å…³é”®è¯ï¼ˆéœ€è¦å…ˆåˆ†è¯ï¼‰
SELECT id, title, ts_rank(content_vector, to_tsquery('simple', 'æ•°æ®åº“')) as score
FROM documents 
WHERE content_vector @@ to_tsquery('simple', 'æ•°æ®åº“')
ORDER BY score DESC LIMIT 3;
```

---

## ğŸ”— ä¸lesson06çš„å¯¹æ¯”

### ç›¸åŒç‚¹
- ä½¿ç”¨ç›¸åŒçš„æ•°æ®åº“å’Œæ–‡æ¡£è¡¨
- ä¿æŒç›¸åŒçš„é¡¹ç›®ç»“æ„
- ç»§ç»­ä½¿ç”¨DockeræœåŠ¡

### æ–°å¢åŠŸèƒ½
- æ·»åŠ äº†PostgreSQLå…¨æ–‡æ£€ç´¢å­—æ®µ
- é›†æˆäº†jiebaä¸­æ–‡åˆ†è¯
- å®ç°äº†å…³é”®è¯æœç´¢åŠŸèƒ½

### ä¸‹èŠ‚è¯¾é¢„å‘Š
- lesson08å°†å­¦ä¹ å¦‚ä½•èåˆå…³é”®è¯æ£€ç´¢å’Œå‘é‡æ£€ç´¢
- å®ç°æ··åˆæ£€ç´¢ç­–ç•¥
- ä¼˜åŒ–æœç´¢ç»“æœçš„å‡†ç¡®æ€§

---

## ğŸ¤” æ€è€ƒé¢˜

1. å…³é”®è¯æœç´¢å’Œå‘é‡æœç´¢å„é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ
2. ä¸ºä»€ä¹ˆéœ€è¦å¯¹ä¸­æ–‡è¿›è¡Œåˆ†è¯å¤„ç†ï¼Ÿ
3. å¦‚ä½•è¯„ä¼°æœç´¢ç»“æœçš„è´¨é‡ï¼Ÿ

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PostgreSQLå…¨æ–‡æ£€ç´¢](https://www.postgresql.org/docs/current/textsearch.html)
- [jiebaåˆ†è¯åº“](https://github.com/fxsjy/jieba)
- [GINç´¢å¼•è¯´æ˜](https://www.postgresql.org/docs/current/gin.html)