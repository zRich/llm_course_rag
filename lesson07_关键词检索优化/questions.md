# Lesson 07 课堂提问与练习

## 课前回顾提问（5分钟）

### Q1：基础概念回顾
**问题**："上节课我们实现了什么类型的检索系统？它的工作原理是什么？"

**参考答案**：
- 向量检索系统
- 工作原理：将文档和查询转换为向量，通过计算向量相似度找到相关文档
- 优势：能理解语义相似性
- 局限：计算成本高，结果不够精确

**追问**："向量检索在什么情况下效果不理想？"
- 需要精确匹配的场景
- 专业术语查找
- 法律条文检索等

## 概念理解提问（15分钟）

### Q2：检索方式对比
**问题**："关键词检索和向量检索的主要区别是什么？请从匹配原理、优势劣势、适用场景三个方面来回答。"

**参考答案**：
| 维度 | 关键词检索 | 向量检索 |
|------|-----------|----------|
| 匹配原理 | 精确词汇匹配 | 语义相似度计算 |
| 优势 | 精确、快速、可解释 | 语义理解强、支持同义词 |
| 劣势 | 无语义理解、同义词问题 | 不够精确、计算成本高 |
| 适用场景 | 法律文档、技术手册、精确查找 | 推荐系统、语义搜索、模糊查询 |

**深入提问**："在什么情况下你会选择关键词检索而不是向量检索？"
- 用户明确知道要查找的关键词
- 需要精确匹配的专业术语
- 对检索速度有严格要求
- 需要可解释的检索结果

### Q3：中文分词重要性
**问题**："为什么中文文本需要分词？英文文本需要吗？这对检索有什么影响？"

**参考答案**：
- **中文特点**：没有天然的词汇分隔符，需要算法识别词汇边界
- **英文特点**：有空格分隔，相对简单
- **检索影响**：
  - 分词质量直接影响检索准确性
  - 错误分词会导致关键词丢失或错误匹配
  - 不同分词策略适用于不同场景

**实例说明**：
```
原文："人工智能技术发展"
错误分词：["人工", "智能", "技术", "发展"]
正确分词：["人工智能", "技术", "发展"]
```

## 技术细节提问（20分钟）

### Q4：PostgreSQL全文检索
**问题**："PostgreSQL中的to_tsvector和to_tsquery函数分别有什么作用？为什么要使用'chinese'配置？"

**参考答案**：
- **to_tsvector**：将文本转换为搜索向量，包含词汇和位置信息
- **to_tsquery**：将查询字符串转换为搜索查询，支持逻辑操作
- **'chinese'配置**：
  - 指定中文文本处理规则
  - 包含中文停用词列表
  - 优化中文分词效果

**演示验证**：
```sql
-- 不指定配置（默认english）
SELECT to_tsvector('人工智能技术');

-- 指定chinese配置
SELECT to_tsvector('chinese', '人工智能技术');
```

### Q5：GIN索引原理
**问题**："为什么我们要为tsvector字段创建GIN索引？它与普通B-tree索引有什么区别？"

**参考答案**：
- **GIN索引特点**：
  - 专门为全文检索设计
  - 支持倒排索引结构
  - 对于包含多个值的字段（如tsvector）优化
- **与B-tree对比**：
  - B-tree适合精确匹配和范围查询
  - GIN适合包含关系查询（@@操作符）
  - 全文检索场景下GIN比B-tree快几个数量级

**性能对比示例**：
```sql
-- 使用GIN索引的查询
EXPLAIN ANALYZE SELECT * FROM documents 
WHERE content_tsvector @@ to_tsquery('chinese', '人工智能');

-- 不使用索引的查询（仅作对比）
EXPLAIN ANALYZE SELECT * FROM documents 
WHERE to_tsvector('chinese', content) @@ to_tsquery('chinese', '人工智能');
```

### Q6：jieba分词模式选择
**问题**："jieba提供了三种分词模式，我们为什么选择精确模式而不是全模式或搜索引擎模式？"

**参考答案**：
- **精确模式**：尽量不重复切分，适合关键词检索
- **全模式**：切分出所有可能的词汇，会产生冗余
- **搜索引擎模式**：在精确模式基础上进一步切分，适合搜索引擎

**选择理由**：
- 避免过度分词导致的噪音
- 保持与用户查询意图的一致性
- 提高检索精度，减少误匹配

## 实践操作提问（25分钟）

### Q7：代码实现理解
**问题**："在preprocess_query函数中，我们为什么要过滤长度小于2的词汇？这样做有什么风险？"

**参考答案**：
- **过滤原因**：
  - 单字符通常不是有效的关键词
  - 减少检索噪音
  - 提高检索精度
- **潜在风险**：
  - 可能过滤掉有意义的单字符（如"AI"中的"A"）
  - 需要根据具体领域调整策略

**改进建议**：
```python
def preprocess_query(query: str) -> List[str]:
    tokens = jieba.cut(query, cut_all=False)
    keywords = []
    for token in tokens:
        token = token.strip()
        # 保留长度>1的词，或者是纯英文/数字的单字符
        if len(token) > 1 or (len(token) == 1 and token.isalnum()):
            keywords.append(token)
    return keywords
```

### Q8：错误处理策略
**问题**："在keyword_search函数中，我们处理了哪些类型的错误？还有什么错误情况需要考虑？"

**参考答案**：
- **已处理的错误**：
  - 空查询或无效查询
  - 数据库连接异常
  - SQL查询语法错误
- **需要补充的错误处理**：
  - 查询超时处理
  - 结果集过大的限制
  - 并发访问控制
  - 资源耗尽处理

**完善建议**：
```python
import signal
from contextlib import contextmanager

@contextmanager
def timeout(seconds):
    def timeout_handler(signum, frame):
        raise TimeoutError("查询超时")
    
    signal.signal(signal.SIGALRM, timeout_handler)
    signal.alarm(seconds)
    try:
        yield
    finally:
        signal.alarm(0)

# 在查询中使用
with timeout(5):  # 5秒超时
    cur.execute(sql, params)
```

### Q9：性能优化思考
**问题**："如果我们的文档数量达到百万级别，当前的实现可能遇到什么性能问题？如何优化？"

**参考答案**：
- **可能的性能问题**：
  - 查询响应时间增长
  - 内存使用过多
  - 并发处理能力不足
- **优化策略**：
  - 分页查询，避免一次返回过多结果
  - 查询结果缓存
  - 数据库连接池
  - 异步查询处理

**优化示例**：
```python
def keyword_search_optimized(query: str, page: int = 1, page_size: int = 10):
    offset = (page - 1) * page_size
    sql = """
    SELECT id, content, score FROM (
        SELECT id, content, 
               ts_rank(content_tsvector, to_tsquery('chinese', %s)) as score
        FROM documents 
        WHERE content_tsvector @@ to_tsquery('chinese', %s)
    ) ranked
    ORDER BY score DESC
    LIMIT %s OFFSET %s
    """
    # 执行分页查询
```

## 综合应用提问（15分钟）

### Q10：系统集成思考
**问题**："现在我们有了向量检索和关键词检索两种能力，在实际应用中应该如何选择使用？能否结合使用？"

**参考答案**：
- **选择策略**：
  - 根据查询类型自动选择
  - 提供用户选择选项
  - 基于查询效果动态切换
- **结合使用方案**：
  - 混合检索：同时使用两种方法，合并结果
  - 级联检索：先用一种方法筛选，再用另一种精化
  - 对比检索：同时展示两种结果供用户选择

### Q11：实际场景应用
**问题**："请举例说明在哪些实际业务场景中，关键词检索比向量检索更合适？"

**学生讨论**（分组讨论5分钟，然后分享）：
- **法律检索**：查找特定法条、案例编号
- **技术文档**：查找API名称、错误代码
- **医疗诊断**：查找特定症状、药品名称
- **电商搜索**：查找特定品牌、型号
- **学术检索**：查找特定作者、期刊名称

## 课堂练习（10分钟）

### 练习1：分词效果测试
**任务**：测试以下查询的分词效果，分析哪些分词结果可能影响检索质量
```python
test_queries = [
    "COVID-19疫苗接种指南",
    "iPhone14Pro最新价格",
    "机器学习vs深度学习",
    "2024年人工智能发展趋势",
    "如何提高Python代码性能"
]
```

**预期输出讨论**：
- 英文和数字的处理
- 专业术语的识别
- 标点符号的影响

### 练习2：查询优化设计
**任务**：为以下用户查询设计最佳的关键词提取策略
- 用户输入："请告诉我关于人工智能在医疗领域应用的最新研究进展"
- 要求：提取有效关键词，设计检索策略

**参考方案**：
```python
# 原始查询
query = "请告诉我关于人工智能在医疗领域应用的最新研究进展"

# 关键词提取
keywords = ["人工智能", "医疗", "领域", "应用", "研究", "进展"]

# 检索策略
# 方案1：全匹配（严格）
search_query = "人工智能 & 医疗 & 应用 & 研究"

# 方案2：核心词匹配（宽松）
search_query = "人工智能 & 医疗 & 应用"

# 方案3：分层匹配
primary_query = "人工智能 & 医疗"
secondary_query = "应用 | 研究 | 进展"
```

## 总结性提问（5分钟）

### Q12：知识整合
**问题**："通过今天的学习，你认为一个完整的检索系统应该具备哪些能力？"

**期望回答要点**：
- 多种检索方式支持（关键词、向量、混合）
- 智能查询预处理（分词、清理、扩展）
- 高效的索引和存储
- 完善的错误处理和容错机制
- 性能监控和优化能力
- 用户友好的接口设计

### Q13：下节课预告
**问题**："下节课我们要学习混合检索策略，你认为应该如何结合关键词检索和向量检索的优势？"

**引导思考**：
- 结果合并策略
- 权重分配方法
- 性能平衡考虑
- 用户体验优化

---

## 提问技巧说明

### 教师提问指导
1. **循序渐进**：从基础概念到技术细节再到综合应用
2. **互动性强**：鼓励学生讨论和分享经验
3. **实践导向**：结合代码实现和实际场景
4. **及时反馈**：对学生回答给予积极反馈和补充

### 常见学生困惑及应对
- **分词效果不理想**：提供更多测试用例，解释分词原理
- **SQL查询复杂**：分步骤演示，提供简化版本
- **性能概念模糊**：用具体数据对比说明
- **应用场景不清**：提供更多实际案例