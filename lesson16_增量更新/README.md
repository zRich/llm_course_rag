# Lesson 16：增量更新与一致性（工程化能力）

## 课次信息
- 时长：90 分钟
- 前置：Lesson 15（批量断点续传与幂等键、检查点、降级策略）已跑通
- 后置：Lesson 17（索引压缩与回滚/审计），将复用本课的版本化与失效契约

## 教学目标（SMART）
- S：在现有 RAG 流水线中实现“增量更新”，包含变更检测、去重与版本化写入，并与缓存/索引失效对齐。
- M：在 1k–10k 文档的变更集下，更新正确率 ≥ 99.5%，重复率 ≤ 0.5%，失效命中率 ≥ 99%，陈旧窗口 ≤ 5 分钟。
- A：基于学生版 `document_processor` 与 `vector_service`、`rerank_service`、`qa_service`，完成端到端增量更新示例与指标采集。
- R：强化课程主线的一致性与可恢复性，与断点续传、分层缓存、索引维护形成闭环。
- T：90 分钟内实现与验收（含现场演示与提交物核对）。

## 教学重点
- 变更检测：`Last-Modified/ETag`、内容哈希 `content_hash`、版本号 `version` 与来源规范化 `normalized_id`。
- 版本化与幂等：`idempotency_key = source + normalized_id + content_hash + layer + version`。
- 失效契约：缓存（问答/检索/重排）与索引（chunk/vector）的层级失效、顺序与回收。
- 部分重建：按文档/分片/段落进行局部更新，控制热区与并发边界。
- 一致性与冲突：最终一致 vs 会话一致；写冲突与竞态处理（租约/轻量锁/重试退避）。

## 教学难点
- 双写与顺序问题：同时更新缓存与索引的时序、回滚与审计。
- 旧值读与陈旧窗口：缓存未失效导致旧数据；需要指标与兜底。
- 热点与碎片化：热门文档频繁更新与索引碎片；需要批量合并与压缩。
- 边界控制：跨块边界更新导致上下文污染；需要严格边界与一致命名。

## 知识点详解
1) 变更检测与差分
   - 检测来源：存储元数据（`Last-Modified/ETag`）、应用级哈希（`content_hash`）、业务版本（`version`）。
   - 差分类型：新增（upsert）、更新（update）、删除（delete/tombstone）。
   - 差分映射：文档 → 分块 → 向量/索引 → 缓存（QA/检索/重排）。
2) 版本化与幂等键
   - 统一键：`source + normalized_id + content_hash + layer + version`；避免自增 ID 与不稳定字段。
   - 幂等写策略：覆盖 vs 合并；记录 `attempts/last_error`；冲突时引入版本比较与租约。
3) 失效与重建顺序（推荐）
   - 先失效缓存，再更新索引，最后重建缓存（写穿/写后/显式刷新）。
   - 依赖图：`doc → chunks → vectors → rerank → qa`；失效传播遵循自顶向下或自底向上策略，保持一致。
4) 部分重建与碎片治理
   - 局部更新：仅针对变更文档的分块与向量重建，避免全量扫描。
   - 碎片治理：批量合并与压缩由 Lesson 17 承接。当前记录重建批次与段落范围。
5) 一致性与指标
   - 指标：`update_accuracy`、`dup_rate`、`stale_window`、`invalidate_hit_rate`、`throughput`、`latency(p50/p95)`。
   - 观测：失败原因分布、回滚次数与审计日志；统一错误结构 `{ error: { code/message/details/hints } }`。

## 完整示例与演示
- 输入示例：见 `examples/input_delta.json`（包含 upserts/updates/deletes 与选项）。
- 期望输出：
  - 检测到的差分统计：新增/更新/删除计数与来源字段（ETag/Last-Modified/hash/version）。
  - 失效事件：`invalidate: qa/retrieval/rerank/vector`，包含命名空间与键。
  - 局部重建日志：分块范围与向量条目数；成功/失败与重试退避。
- 异常与兜底：
  - 400：参数缺失/格式错误；返回统一错误结构。
  - 500：外部服务不可用/写冲突；触发重试与租约回退；必要时标记为待回滚。

## 授课老师指导（时间轴）
- 导入（10’）：目标与产物；与 Lesson 15 的契约衔接（幂等键/检查点/降级）。
- 讲解（25’）：变更检测、版本化幂等、失效与重建顺序、并发边界与一致性。
- 实践（40’）：运行增量更新示例，注入更新/删除与故障，观测指标与日志；核对陈旧窗口与命中率。
- 总结（15’）：复盘指标与提交物，列出常见误区与改正策略。

### 教师讲稿（可直接照读）
- 开场：本课核心是“正确检测差分 + 正确失效重建 + 一致性可观测”。
- 术语：ETag/Last-Modified、content_hash、idempotency、invalidate、tombstone、stale window。
- 示例：输入 delta、失效顺序与局部重建；如何验证命中率与陈旧窗口。
- 一致性：统一命名与错误结构；与后续索引压缩/审计的承接。

### 课堂提问与练习（含参考答案）
- 问：为什么“先失效缓存再更新索引”？答：避免读到旧值，降低陈旧窗口；最终重建写穿或显式刷新。
- 问：如何处理写冲突？答：版本比较 + 轻量锁/租约 + 重试退避，必要时审计回滚。
- 练习：将 3% 文档标记删除（tombstone），观察检索/QA 的失效传播与指标变化。

## 黑板/投屏操作步骤（逐步）
1. 打开 `examples/input_delta.json`，解释 upserts/updates/deletes 与版本/哈希字段。
2. 运行增量更新：展示差分统计、失效事件与局部重建日志。
3. 注入故障：模拟外部向量服务超时或写冲突，观察重试与租约回退。
4. 验证一致性：核对陈旧窗口 ≤ 5 分钟、失效命中率 ≥ 99%，重复率 ≤ 0.5%。
5. 打开 `checklist.md`：逐条勾选验收标准与提交物清单。

## 学生任务
- 在 `labs/student/lab03/src/services/document_processor.py` 与相关服务中：
  - 实现增量更新入口与差分检测（upsert/update/delete/tombstone）。
  - 设计版本化幂等键并用于去重与覆盖写。
  - 实现缓存/索引的层级失效与局部重建（顺序与边界控制）。
  - 输出指标与日志：差分统计、失效命中率、陈旧窗口、吞吐与延迟。
- 编写 1k+ 文档的增量更新实验，提交评估数据与截图。

## 对齐与连续性
- 与主线契约对齐：统一错误结构、字段命名与统计口径。
- 承接 Lesson 15 的幂等键与检查点；引出 Lesson 17 的索引压缩与回滚/审计。

## 提交与验收
- 评估指标（建议阈值）：
  - 更新正确率 ≥ 99.5%，重复率 ≤ 0.5%，失效命中率 ≥ 99%。
  - 陈旧窗口 ≤ 5 分钟；吞吐与延迟给出 p50/p95；附日志与截图。
- 验收流程：
  - 运行增量两次（含故障注入），核对差分与失效有效，重复率与窗口达标。
  - 查看统一错误结构与分类统计；检查冲突处理与回退日志。

## 术语与概念定义
- ETag/Last-Modified：来源存储的变更标识；可用于快速差分。
- 内容哈希（content_hash）：应用级规范化后内容的哈希值，敏感于语义变化。
- 幂等（idempotency）：多次执行结果一致；通过键与去重保障工程上的一致性。
- 失效（invalidate）：主动清除或标记旧值无效，以触发重建或下一次读写穿。
- 墓碑（tombstone）：删除记录的持久化标记，用于传播失效与一致性审计。
- 陈旧窗口（stale window）：从变更发生到系统整体一致的时间窗口。

## 提交前检查清单（教师/学生）
- 三要素齐备：目标/重点/难点可测量。
- 示例完整：包含输入 delta、失效事件与重建日志；错误结构统一。
- 教师指导可执行：时间轴与话术明确；黑板步骤可复现。
- 一致性：字段命名与指标口径统一；与主线契约对齐。
- 验收阈值：达标且可验证（含截图与日志）。

## 边界声明
- 不覆盖分布式队列的跨进程一致性/强事务实现；回滚与索引压缩细节留给 Lesson 17。

---

导航与配套材料（与 lecture-best-practices.md 对齐）：
- 教师讲稿：`./teacher-script.md`
- 黑板/投屏步骤：`./blackboard-steps.md`
- 提交前检查清单：`./checklist.md`
- 示例与模板：`./examples/`（输入 delta）、`./templates/`（提交模板）