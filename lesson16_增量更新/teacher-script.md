# Lesson 16 教师讲稿（照读脚本）

## 时间轴与环节
- 开场（5’）
- 目标与产物（10’）
- 概念与契约（15’）
- 架构与顺序（10’）
- 端到端演示（25’）
- 故障注入与冲突处理（15’）
- 指标复盘与提交要求（5’）
- 问答与总结（5’）

## 开场话术（可照读）
- 今天我们聚焦“增量更新与一致性”。核心是正确检测差分、正确失效与重建、正确度量一致性，最终形成与缓存/索引的契约闭环。
- 产物包括：差分检测实现、版本化幂等键、失效顺序与局部重建、冲突处理与审计日志、完整的实验数据与验收截图。

## 核心术语与定义
- ETag/Last-Modified：来源存储的变更标识，用于快速差分。
- 内容哈希（content_hash）：规范化后内容的哈希值，敏感于语义变化。
- 幂等（idempotency）：通过键与去重，保障工程上的一致性。
- 失效（invalidate）：主动清除或标记旧值无效，触发重建或写穿。
- 墓碑（tombstone）：删除记录的持久化标记。
- 陈旧窗口（stale window）：从变更发生到系统一致的时间窗口。

## 架构与实现要点（讲解脚本）
- 差分类型：新增/更新/删除；映射到文档→分块→向量→重排→QA 缓存。
- 幂等键：`source + normalized_id + content_hash + layer + version`；避免不稳定 ID。
- 失效顺序：先失效缓存，再更新索引，最后重建缓存；记录命名空间与键。
- 并发边界：文档级并发、分块内同步；写冲突使用版本比较与租约，配合重试退避。
- 可观测性：差分统计、失效命中率、陈旧窗口、吞吐与延迟；统一错误结构。

## 端到端演示（步骤与话术）
1. 展示 `examples/input_delta.json` 的 upserts/updates/deletes 与版本/哈希字段。
2. 首次运行增量更新：观察差分统计、失效事件与局部重建日志；指出失效命名空间与键设计。
3. 注入故障：模拟向量服务短暂超时或写冲突；观察重试退避与租约回退日志。
4. 二次运行：验证重复率 ≤ 0.5%、失效命中率 ≥ 99%、陈旧窗口 ≤ 5 分钟。
5. 打开 `checklist.md`，逐条对照验收标准并现场勾选。

## 课堂提问与互动（含参考答案）
- 问：为什么先失效缓存再更新索引？答：降低旧值读取风险，缩短陈旧窗口；最后重建写穿或显式刷新。
- 问：写冲突如何处理？答：版本比较 + 轻量锁/租约 + 重试退避；必要时标记待回滚并审计。
- 问：如何度量失效命中率与陈旧窗口？答：输出 `invalidate_hit_rate` 与 `stale_window`，结合日志与统计接口采集。

## 总结话术
- 增量更新的关键在于“差分检测 + 失效与重建顺序 + 一致性治理”。
- 与下一课强关联：索引压缩与回滚/审计将复用今天的版本化与日志治理。

## 提交要求与验收复盘
- 提交内容：实现简述、配置参数、实验数据（两次运行：首次与故障注入后）、日志与截图。
- 验收阈值：更新正确率 ≥ 99.5%，重复率 ≤ 0.5%，失效命中率 ≥ 99%，陈旧窗口 ≤ 5 分钟；错误结构统一且可追溯。