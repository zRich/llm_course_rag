# Lesson 20: æ•…éšœæ³¨å…¥ä¸æ¢å¤æ¼”ç»ƒ - å­¦ç”Ÿå®éªŒæŒ‡å¯¼

## å®éªŒæ¦‚è¿°

### å®éªŒç›®æ ‡
- æŒæ¡æ•…éšœæ³¨å…¥æŠ€æœ¯çš„åŸºæœ¬åŸç†å’Œåº”ç”¨
- å­¦ä¼šå®ç°å’Œé…ç½®ç³»ç»Ÿæ¢å¤æœºåˆ¶
- ç†è§£ç›‘æ§å‘Šè­¦åœ¨ç³»ç»Ÿå¯é æ€§ä¸­çš„ä½œç”¨
- åœ¨RAGç³»ç»Ÿä¸­åº”ç”¨å®¹é”™è®¾è®¡æ¨¡å¼

### å®éªŒç¯å¢ƒ
- Python 3.8+
- å·²å®Œæˆçš„RAGç³»ç»Ÿé¡¹ç›®
- æ•…éšœæ³¨å…¥å’Œæ¢å¤æœºåˆ¶æ¡†æ¶

### é¢„è®¡æ—¶é—´
45åˆ†é’Ÿ

## å®éªŒå‡†å¤‡

### 1. ç¯å¢ƒæ£€æŸ¥
```bash
# ç¡®è®¤å½“å‰åœ¨lesson20åˆ†æ”¯
git branch

# æ£€æŸ¥é¡¹ç›®ç»“æ„
ls -la src/fault_injection/
ls -la src/recovery/
ls -la src/monitoring/
```

### 2. å®‰è£…ä¾èµ–
```bash
# å®‰è£…ç³»ç»Ÿç›‘æ§ä¾èµ–
pip install psutil requests
```

### 3. åˆ›å»ºå®éªŒç›®å½•
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºå®éªŒæ–‡ä»¶å¤¹
mkdir -p experiments/lesson20
cd experiments/lesson20
```

## å®éªŒä¸€ï¼šæ•…éšœæ³¨å…¥åŸºç¡€ (10åˆ†é’Ÿ)

### 1.1 åˆ›å»ºåŸºç¡€æµ‹è¯•æ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ `fault_injection_demo.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•…éšœæ³¨å…¥æ¼”ç¤º
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))

from src.fault_injection import FaultInjector, FaultType, fault_injection_decorator
import time
import random

def demo_basic_fault_injection():
    """æ¼”ç¤ºåŸºç¡€æ•…éšœæ³¨å…¥"""
    print("=== åŸºç¡€æ•…éšœæ³¨å…¥æ¼”ç¤º ===")
    
    # åˆ›å»ºæ•…éšœæ³¨å…¥å™¨
    injector = FaultInjector()
    
    # é…ç½®ç½‘ç»œè¶…æ—¶æ•…éšœ
    injector.configure_fault(FaultType.NETWORK_TIMEOUT, probability=0.3)
    
    def simulate_api_call():
        """æ¨¡æ‹ŸAPIè°ƒç”¨"""
        time.sleep(0.1)  # æ­£å¸¸å“åº”æ—¶é—´
        return {"status": "success", "data": f"response_{random.randint(1, 100)}"}
    
    # æµ‹è¯•æ•…éšœæ³¨å…¥
    success_count = 0
    failure_count = 0
    
    for i in range(10):
        try:
            result = injector.inject_fault("api_call", simulate_api_call)
            print(f"âœ… è°ƒç”¨ {i+1}: æˆåŠŸ - {result}")
            success_count += 1
        except Exception as e:
            print(f"âŒ è°ƒç”¨ {i+1}: å¤±è´¥ - {str(e)}")
            failure_count += 1
    
    print(f"\nğŸ“Š ç»Ÿè®¡ç»“æœ: æˆåŠŸ {success_count} æ¬¡, å¤±è´¥ {failure_count} æ¬¡")
    print(f"ğŸ“ˆ æ•…éšœç‡: {failure_count/10*100:.1f}%")

def demo_decorator_fault_injection():
    """æ¼”ç¤ºè£…é¥°å™¨æ•…éšœæ³¨å…¥"""
    print("\n=== è£…é¥°å™¨æ•…éšœæ³¨å…¥æ¼”ç¤º ===")
    
    @fault_injection_decorator(FaultType.SLOW_RESPONSE, probability=0.4)
    def process_request(data):
        """å¤„ç†è¯·æ±‚"""
        return f"å¤„ç†å®Œæˆ: {data}"
    
    # æµ‹è¯•è£…é¥°å™¨æ•…éšœæ³¨å…¥
    for i in range(5):
        start_time = time.time()
        try:
            result = process_request(f"request_{i}")
            duration = time.time() - start_time
            print(f"ğŸ”„ è¯·æ±‚ {i+1}: {result}, è€—æ—¶: {duration:.2f}s")
        except Exception as e:
            duration = time.time() - start_time
            print(f"â±ï¸ è¯·æ±‚ {i+1}: å¤±è´¥ - {str(e)}, è€—æ—¶: {duration:.2f}s")

def demo_multiple_fault_types():
    """æ¼”ç¤ºå¤šç§æ•…éšœç±»å‹"""
    print("\n=== å¤šç§æ•…éšœç±»å‹æ¼”ç¤º ===")
    
    injector = FaultInjector()
    
    # é…ç½®å¤šç§æ•…éšœ
    injector.configure_fault(FaultType.SERVICE_UNAVAILABLE, probability=0.2)
    injector.configure_fault(FaultType.DATA_CORRUPTION, probability=0.1)
    injector.configure_fault(FaultType.MEMORY_ERROR, probability=0.1)
    
    def database_operation(operation_type):
        """æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ"""
        operations = {
            "read": lambda: {"data": ["item1", "item2", "item3"]},
            "write": lambda: {"status": "written", "id": random.randint(1, 1000)},
            "delete": lambda: {"status": "deleted", "count": 1}
        }
        return operations[operation_type]()
    
    operations = ["read", "write", "delete"] * 3
    
    for i, op in enumerate(operations):
        try:
            result = injector.inject_fault(f"db_{op}", lambda: database_operation(op))
            print(f"ğŸ’¾ æ“ä½œ {i+1} ({op}): æˆåŠŸ - {result}")
        except Exception as e:
            print(f"ğŸ’¥ æ“ä½œ {i+1} ({op}): å¤±è´¥ - {str(e)}")

if __name__ == "__main__":
    demo_basic_fault_injection()
    demo_decorator_fault_injection()
    demo_multiple_fault_types()
    
    print("\nğŸ¯ å®éªŒä¸€å®Œæˆï¼è¯·è§‚å¯Ÿä¸åŒæ•…éšœç±»å‹çš„è¡¨ç°ã€‚")
```

### 1.2 è¿è¡Œå®éªŒä¸€
```bash
python fault_injection_demo.py
```

### 1.3 è§‚å¯Ÿå’Œè®°å½•
- è®°å½•ä¸åŒæ•…éšœç±»å‹çš„è¡¨ç°
- è§‚å¯Ÿæ•…éšœæ¦‚ç‡çš„å®é™…æ•ˆæœ
- æ€è€ƒï¼šå“ªäº›æ•…éšœç±»å‹å¯¹ç³»ç»Ÿå½±å“æœ€å¤§ï¼Ÿ

## å®éªŒäºŒï¼šæ¢å¤æœºåˆ¶å®è·µ (15åˆ†é’Ÿ)

### 2.1 åˆ›å»ºæ¢å¤æœºåˆ¶æµ‹è¯•æ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ `recovery_demo.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ¢å¤æœºåˆ¶æ¼”ç¤º
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))

from src.recovery import (
    retry_with_backoff, RetryStrategy, 
    CircuitBreaker, CircuitBreakerState,
    FallbackService, FallbackStrategy
)
import time
import random

def demo_retry_mechanism():
    """æ¼”ç¤ºé‡è¯•æœºåˆ¶"""
    print("=== é‡è¯•æœºåˆ¶æ¼”ç¤º ===")
    
    # æ¨¡æ‹Ÿä¸ç¨³å®šçš„æœåŠ¡
    call_count = 0
    
    @retry_with_backoff(
        max_attempts=3,
        strategy=RetryStrategy.EXPONENTIAL_BACKOFF,
        base_delay=0.5
    )
    def unreliable_service(service_name):
        nonlocal call_count
        call_count += 1
        
        print(f"  ğŸ”„ å°è¯•è°ƒç”¨ {service_name} (ç¬¬ {call_count} æ¬¡)")
        
        # 70%çš„å¤±è´¥ç‡
        if random.random() < 0.7:
            raise Exception(f"{service_name} æœåŠ¡ä¸´æ—¶ä¸å¯ç”¨")
        
        return f"{service_name} è°ƒç”¨æˆåŠŸ"
    
    # æµ‹è¯•é‡è¯•æœºåˆ¶
    services = ["ç”¨æˆ·æœåŠ¡", "è®¢å•æœåŠ¡", "æ”¯ä»˜æœåŠ¡"]
    
    for service in services:
        call_count = 0
        try:
            start_time = time.time()
            result = unreliable_service(service)
            duration = time.time() - start_time
            print(f"âœ… {service}: {result} (è€—æ—¶: {duration:.2f}s, å°è¯•æ¬¡æ•°: {call_count})")
        except Exception as e:
            duration = time.time() - start_time
            print(f"âŒ {service}: æœ€ç»ˆå¤±è´¥ - {str(e)} (è€—æ—¶: {duration:.2f}s, å°è¯•æ¬¡æ•°: {call_count})")
        print()

def demo_circuit_breaker():
    """æ¼”ç¤ºç†”æ–­å™¨æ¨¡å¼"""
    print("\n=== ç†”æ–­å™¨æ¨¡å¼æ¼”ç¤º ===")
    
    # åˆ›å»ºç†”æ–­å™¨
    breaker = CircuitBreaker(
        failure_threshold=3,
        timeout_seconds=5,
        half_open_max_calls=2
    )
    
    def failing_service(request_id):
        """ç»å¸¸å¤±è´¥çš„æœåŠ¡"""
        # 80%çš„å¤±è´¥ç‡
        if random.random() < 0.8:
            raise Exception(f"æœåŠ¡é”™è¯¯ (è¯·æ±‚ {request_id})")
        return f"è¯·æ±‚ {request_id} å¤„ç†æˆåŠŸ"
    
    print("å¼€å§‹æµ‹è¯•ç†”æ–­å™¨...")
    
    # æµ‹è¯•ç†”æ–­å™¨
    for i in range(15):
        try:
            result = breaker.call(lambda: failing_service(i+1))
            print(f"âœ… è°ƒç”¨ {i+1}: {result} (çŠ¶æ€: {breaker.state.value})")
        except Exception as e:
            print(f"âŒ è°ƒç”¨ {i+1}: {str(e)} (çŠ¶æ€: {breaker.state.value})")
        
        # æ˜¾ç¤ºç†”æ–­å™¨ç»Ÿè®¡
        stats = breaker.get_statistics()
        print(f"   ğŸ“Š æˆåŠŸç‡: {stats['success_rate']:.1f}%, å¤±è´¥ç‡: {stats['failure_rate']:.1f}%")
        
        time.sleep(0.5)
        
        # åœ¨ç†”æ–­å™¨æ‰“å¼€æ—¶ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´è®©å®ƒè¿›å…¥åŠå¼€çŠ¶æ€
        if breaker.state == CircuitBreakerState.OPEN and i == 8:
            print("\nâ³ ç­‰å¾…ç†”æ–­å™¨è¶…æ—¶ï¼Œè¿›å…¥åŠå¼€çŠ¶æ€...")
            time.sleep(6)

def demo_fallback_service():
    """æ¼”ç¤ºé™çº§æœåŠ¡"""
    print("\n=== é™çº§æœåŠ¡æ¼”ç¤º ===")
    
    # åˆ›å»ºé™çº§æœåŠ¡
    fallback = FallbackService()
    fallback.configure(FallbackStrategy.CACHE, cache_ttl=10)
    
    def get_user_profile(user_id):
        """è·å–ç”¨æˆ·èµ„æ–™"""
        # 50%çš„å¤±è´¥ç‡
        if random.random() < 0.5:
            raise Exception(f"ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨ (ç”¨æˆ· {user_id})")
        
        return {
            "id": user_id,
            "name": f"User{user_id}",
            "email": f"user{user_id}@example.com",
            "created_at": time.time()
        }
    
    # æµ‹è¯•é™çº§æœåŠ¡
    user_ids = [1, 2, 1, 3, 2, 4, 1]  # é‡å¤è®¿é—®ç”¨æˆ·1å’Œ2æµ‹è¯•ç¼“å­˜
    
    for user_id in user_ids:
        try:
            result = fallback.execute_with_fallback(
                f"user_profile_{user_id}",
                lambda: get_user_profile(user_id),
                default_value={
                    "id": user_id,
                    "name": f"é»˜è®¤ç”¨æˆ·{user_id}",
                    "email": "default@example.com",
                    "created_at": time.time()
                }
            )
            
            # æ£€æŸ¥æ˜¯å¦æ¥è‡ªç¼“å­˜
            cache_hit = "created_at" in result and time.time() - result["created_at"] > 1
            cache_status = "(ç¼“å­˜å‘½ä¸­)" if cache_hit else "(å®æ—¶æ•°æ®)"
            
            print(f"ğŸ‘¤ ç”¨æˆ· {user_id}: {result['name']} {cache_status}")
            
        except Exception as e:
            print(f"âŒ ç”¨æˆ· {user_id}: è·å–å¤±è´¥ - {str(e)}")
        
        time.sleep(0.5)
    
    # æ˜¾ç¤ºé™çº§æœåŠ¡ç»Ÿè®¡
    stats = fallback.get_statistics()
    print(f"\nğŸ“Š é™çº§æœåŠ¡ç»Ÿè®¡:")
    print(f"   æ€»è°ƒç”¨: {stats['total_calls']}")
    print(f"   æˆåŠŸ: {stats['successful_calls']}")
    print(f"   é™çº§: {stats['fallback_calls']}")
    print(f"   ç¼“å­˜å‘½ä¸­: {stats['cache_hits']}")

if __name__ == "__main__":
    demo_retry_mechanism()
    demo_circuit_breaker()
    demo_fallback_service()
    
    print("\nğŸ¯ å®éªŒäºŒå®Œæˆï¼è¯·è§‚å¯Ÿä¸åŒæ¢å¤æœºåˆ¶çš„æ•ˆæœã€‚")
```

### 2.2 è¿è¡Œå®éªŒäºŒ
```bash
python recovery_demo.py
```

### 2.3 è§‚å¯Ÿå’Œåˆ†æ
- è§‚å¯Ÿé‡è¯•æœºåˆ¶çš„å»¶è¿Ÿç­–ç•¥
- è®°å½•ç†”æ–­å™¨çŠ¶æ€è½¬æ¢è¿‡ç¨‹
- åˆ†æé™çº§æœåŠ¡çš„ç¼“å­˜æ•ˆæœ

## å®éªŒä¸‰ï¼šç›‘æ§å‘Šè­¦ç³»ç»Ÿ (10åˆ†é’Ÿ)

### 3.1 åˆ›å»ºç›‘æ§æ¼”ç¤ºæ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ `monitoring_demo.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç›‘æ§å‘Šè­¦æ¼”ç¤º
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))

from src.monitoring import (
    global_system_monitor, global_alert_manager, global_metrics_collector,
    create_error_rate_rule, create_response_time_rule,
    AlertLevel, AlertCondition, AlertRule
)
import time
import random

def demo_metrics_collection():
    """æ¼”ç¤ºæŒ‡æ ‡æ”¶é›†"""
    print("=== æŒ‡æ ‡æ”¶é›†æ¼”ç¤º ===")
    
    collector = global_metrics_collector
    
    # æ¨¡æ‹Ÿä¸šåŠ¡æŒ‡æ ‡
    print("ğŸ“Š å¼€å§‹æ”¶é›†æŒ‡æ ‡...")
    
    for i in range(10):
        # æ¨¡æ‹Ÿè¯·æ±‚å¤„ç†
        response_time = random.uniform(0.1, 2.0)
        success = random.random() > 0.1  # 90%æˆåŠŸç‡
        
        # è®°å½•æŒ‡æ ‡
        collector.record_counter("requests_total", 1, {"status": "success" if success else "error"})
        collector.record_timer("response_time", response_time, {"endpoint": "/api/search"})
        collector.record_gauge("active_connections", random.randint(10, 50))
        
        if success:
            print(f"âœ… è¯·æ±‚ {i+1}: æˆåŠŸ, å“åº”æ—¶é—´: {response_time:.2f}s")
        else:
            print(f"âŒ è¯·æ±‚ {i+1}: å¤±è´¥, å“åº”æ—¶é—´: {response_time:.2f}s")
        
        time.sleep(0.2)
    
    # æ˜¾ç¤ºæŒ‡æ ‡æ‘˜è¦
    print("\nğŸ“ˆ æŒ‡æ ‡æ‘˜è¦:")
    metrics = collector.get_metrics_summary()
    for name, data in metrics.items():
        if 'count' in data:
            print(f"   {name}: {data['count']} æ¬¡")
        elif 'value' in data:
            print(f"   {name}: {data['value']:.2f}")

def demo_alert_system():
    """æ¼”ç¤ºå‘Šè­¦ç³»ç»Ÿ"""
    print("\n=== å‘Šè­¦ç³»ç»Ÿæ¼”ç¤º ===")
    
    alert_manager = global_alert_manager
    
    # æ·»åŠ å‘Šè­¦è§„åˆ™
    error_rule = create_error_rate_rule(
        "high_error_rate",
        threshold=0.15,  # 15%é”™è¯¯ç‡
        level=AlertLevel.WARNING
    )
    
    response_rule = create_response_time_rule(
        "slow_response",
        threshold=1.5,  # 1.5ç§’å“åº”æ—¶é—´
        level=AlertLevel.ERROR
    )
    
    # è‡ªå®šä¹‰è§„åˆ™ï¼šæ´»è·ƒè¿æ¥æ•°è¿‡é«˜
    connection_rule = AlertRule(
        name="high_connections",
        metric_name="active_connections",
        condition=AlertCondition.GREATER_THAN,
        threshold=40,
        level=AlertLevel.WARNING,
        description="æ´»è·ƒè¿æ¥æ•°è¿‡é«˜"
    )
    
    alert_manager.add_rule(error_rule)
    alert_manager.add_rule(response_rule)
    alert_manager.add_rule(connection_rule)
    
    print("ğŸš¨ å¼€å§‹ç›‘æ§å‘Šè­¦...")
    
    # æ¨¡æ‹ŸæŒ‡æ ‡å˜åŒ–è§¦å‘å‘Šè­¦
    for i in range(15):
        # é€æ¸å¢åŠ é”™è¯¯ç‡
        error_rate = 0.05 + (i * 0.02)
        
        # éšæœºå“åº”æ—¶é—´ï¼Œå¶å°”å¾ˆæ…¢
        response_time = random.uniform(0.5, 3.0) if random.random() > 0.7 else random.uniform(0.1, 1.0)
        
        # æ´»è·ƒè¿æ¥æ•°
        connections = random.randint(20, 60)
        
        # è¯„ä¼°æŒ‡æ ‡
        alert_manager.evaluate_metric("error_rate", error_rate)
        alert_manager.evaluate_metric("response_time", response_time)
        alert_manager.evaluate_metric("active_connections", connections)
        
        print(f"ğŸ“Š å‘¨æœŸ {i+1}: é”™è¯¯ç‡={error_rate:.2f}, å“åº”æ—¶é—´={response_time:.2f}s, è¿æ¥æ•°={connections}")
        
        # æ˜¾ç¤ºæ´»è·ƒå‘Šè­¦
        active_alerts = alert_manager.get_active_alerts()
        if active_alerts:
            for alert in active_alerts:
                print(f"   ğŸš¨ å‘Šè­¦: {alert.rule_name} - {alert.message}")
        
        time.sleep(0.5)
    
    # æ˜¾ç¤ºå‘Šè­¦ç»Ÿè®¡
    print("\nğŸ“Š å‘Šè­¦ç»Ÿè®¡:")
    stats = alert_manager.get_statistics()
    print(f"   æ€»å‘Šè­¦æ•°: {stats['total_alerts']}")
    print(f"   æ´»è·ƒå‘Šè­¦: {stats['active_alerts']}")
    print(f"   å·²è§£å†³: {stats['resolved_alerts']}")

def demo_system_health():
    """æ¼”ç¤ºç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    print("\n=== ç³»ç»Ÿå¥åº·æ£€æŸ¥æ¼”ç¤º ===")
    
    monitor = global_system_monitor
    
    # è¿è¡Œå¥åº·æ£€æŸ¥
    print("ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥...")
    results = monitor.run_all_health_checks()
    
    for result in results:
        status_icon = "âœ…" if result.status.value == "healthy" else "âŒ"
        print(f"{status_icon} {result.name}: {result.message} ({result.duration_ms:.1f}ms)")
    
    # è·å–ç³»ç»ŸæŒ‡æ ‡
    print("\nğŸ’» ç³»ç»ŸæŒ‡æ ‡:")
    try:
        metrics = monitor.get_system_metrics()
        print(f"   CPUä½¿ç”¨ç‡: {metrics.cpu_percent:.1f}%")
        print(f"   å†…å­˜ä½¿ç”¨ç‡: {metrics.memory_percent:.1f}%")
        print(f"   å¯ç”¨å†…å­˜: {metrics.memory_available_mb:.0f}MB")
        print(f"   ç£ç›˜ä½¿ç”¨ç‡: {metrics.disk_usage_percent:.1f}%")
        print(f"   è¿›ç¨‹æ•°: {metrics.process_count}")
        if metrics.load_average:
            print(f"   è´Ÿè½½å¹³å‡å€¼: {metrics.load_average}")
    except Exception as e:
        print(f"   âŒ è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥: {str(e)}")
    
    # è·å–æ•´ä½“å¥åº·çŠ¶æ€
    overall_health = monitor.get_overall_health()
    health_icon = {
        "healthy": "ğŸ’š",
        "warning": "ğŸ’›", 
        "unhealthy": "â¤ï¸",
        "unknown": "ğŸ¤"
    }.get(overall_health.value, "ğŸ¤")
    
    print(f"\n{health_icon} ç³»ç»Ÿæ•´ä½“å¥åº·çŠ¶æ€: {overall_health.value.upper()}")

if __name__ == "__main__":
    demo_metrics_collection()
    demo_alert_system()
    demo_system_health()
    
    print("\nğŸ¯ å®éªŒä¸‰å®Œæˆï¼è¯·è§‚å¯Ÿç›‘æ§å‘Šè­¦ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µã€‚")
```

### 3.2 è¿è¡Œå®éªŒä¸‰
```bash
python monitoring_demo.py
```

## å®éªŒå››ï¼šRAGç³»ç»Ÿé›†æˆ (10åˆ†é’Ÿ)

### 4.1 åˆ›å»ºRAGé›†æˆç¤ºä¾‹

åˆ›å»ºæ–‡ä»¶ `rag_integration_demo.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RAGç³»ç»Ÿå®¹é”™é›†æˆæ¼”ç¤º
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))

from src.fault_injection import fault_injection_decorator, FaultType
from src.recovery import (
    retry_with_backoff, RetryStrategy,
    CircuitBreaker, FallbackService, FallbackStrategy
)
from src.monitoring import global_metrics_collector, global_alert_manager
import time
import random

class RobustRAGService:
    """å®¹é”™çš„RAGæœåŠ¡"""
    
    def __init__(self):
        self.vector_circuit_breaker = CircuitBreaker(failure_threshold=3)
        self.llm_circuit_breaker = CircuitBreaker(failure_threshold=2)
        self.fallback_service = FallbackService()
        self.fallback_service.configure(FallbackStrategy.CACHE, cache_ttl=300)
        
        # åˆå§‹åŒ–æŒ‡æ ‡æ”¶é›†
        self.metrics = global_metrics_collector
        
        print("ğŸ¤– RobustRAGService åˆå§‹åŒ–å®Œæˆ")
    
    @fault_injection_decorator(FaultType.NETWORK_TIMEOUT, probability=0.1)
    @retry_with_backoff(max_attempts=3, strategy=RetryStrategy.EXPONENTIAL_BACKOFF)
    def query_vector_store(self, query):
        """æŸ¥è¯¢å‘é‡å­˜å‚¨"""
        start_time = time.time()
        
        try:
            # æ¨¡æ‹Ÿå‘é‡æŸ¥è¯¢
            if random.random() < 0.2:  # 20%å¤±è´¥ç‡
                raise Exception("å‘é‡å­˜å‚¨æŸ¥è¯¢å¤±è´¥")
            
            # æ¨¡æ‹ŸæŸ¥è¯¢å»¶è¿Ÿ
            time.sleep(random.uniform(0.1, 0.5))
            
            docs = [
                f"æ–‡æ¡£1: å…³äº{query}çš„ç›¸å…³å†…å®¹...",
                f"æ–‡æ¡£2: {query}çš„è¯¦ç»†è¯´æ˜...",
                f"æ–‡æ¡£3: {query}çš„åº”ç”¨æ¡ˆä¾‹..."
            ]
            
            # è®°å½•æˆåŠŸæŒ‡æ ‡
            duration = time.time() - start_time
            self.metrics.record_timer("vector_query_duration", duration)
            self.metrics.record_counter("vector_queries_total", 1, {"status": "success"})
            
            return docs
            
        except Exception as e:
            # è®°å½•å¤±è´¥æŒ‡æ ‡
            duration = time.time() - start_time
            self.metrics.record_timer("vector_query_duration", duration)
            self.metrics.record_counter("vector_queries_total", 1, {"status": "error"})
            raise e
    
    @fault_injection_decorator(FaultType.SLOW_RESPONSE, probability=0.15)
    def generate_response(self, context, query):
        """ç”Ÿæˆå›ç­”"""
        start_time = time.time()
        
        try:
            # ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤LLMè°ƒç”¨
            def llm_call():
                if random.random() < 0.25:  # 25%å¤±è´¥ç‡
                    raise Exception("LLMæœåŠ¡ä¸å¯ç”¨")
                
                # æ¨¡æ‹ŸLLMå¤„ç†æ—¶é—´
                time.sleep(random.uniform(0.2, 1.0))
                
                return f"åŸºäºæä¾›çš„ä¸Šä¸‹æ–‡ï¼Œå…³äº'{query}'çš„å›ç­”æ˜¯ï¼šè¿™æ˜¯ä¸€ä¸ªè¯¦ç»†çš„è§£ç­”ï¼Œç»“åˆäº†ç›¸å…³æ–‡æ¡£çš„ä¿¡æ¯ã€‚"
            
            response = self.llm_circuit_breaker.call(llm_call)
            
            # è®°å½•æˆåŠŸæŒ‡æ ‡
            duration = time.time() - start_time
            self.metrics.record_timer("llm_response_duration", duration)
            self.metrics.record_counter("llm_calls_total", 1, {"status": "success"})
            
            return response
            
        except Exception as e:
            # è®°å½•å¤±è´¥æŒ‡æ ‡
            duration = time.time() - start_time
            self.metrics.record_timer("llm_response_duration", duration)
            self.metrics.record_counter("llm_calls_total", 1, {"status": "error"})
            raise e
    
    def search_with_fallback(self, query):
        """å¸¦é™çº§çš„æœç´¢"""
        def primary_search():
            # æŸ¥è¯¢å‘é‡å­˜å‚¨
            docs = self.query_vector_store(query)
            
            # ç”Ÿæˆå›ç­”
            response = self.generate_response(docs, query)
            
            return {
                "success": True,
                "response": response,
                "source": "primary",
                "documents": len(docs)
            }
        
        # ä½¿ç”¨é™çº§æœåŠ¡
        try:
            result = self.fallback_service.execute_with_fallback(
                f"search_{hash(query) % 1000}",  # ç®€å•çš„ç¼“å­˜é”®
                primary_search,
                default_value={
                    "success": True,
                    "response": f"æŠ±æ­‰ï¼Œç”±äºç³»ç»Ÿç¹å¿™ï¼Œæ— æ³•æä¾›å…³äº'{query}'çš„è¯¦ç»†å›ç­”ã€‚è¯·ç¨åé‡è¯•ã€‚",
                    "source": "fallback",
                    "documents": 0
                }
            )
            
            # è®°å½•æœç´¢æŒ‡æ ‡
            self.metrics.record_counter("searches_total", 1, {"source": result["source"]})
            
            return result
            
        except Exception as e:
            # æœ€ç»ˆé™çº§
            self.metrics.record_counter("searches_total", 1, {"source": "error"})
            return {
                "success": False,
                "error": str(e),
                "response": "ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚",
                "source": "error"
            }

def demo_rag_integration():
    """æ¼”ç¤ºRAGç³»ç»Ÿé›†æˆ"""
    print("=== RAGç³»ç»Ÿå®¹é”™é›†æˆæ¼”ç¤º ===")
    
    # åˆ›å»ºå®¹é”™RAGæœåŠ¡
    rag_service = RobustRAGService()
    
    # æµ‹è¯•æŸ¥è¯¢
    queries = [
        "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
        "æ·±åº¦å­¦ä¹ çš„åº”ç”¨åœºæ™¯",
        "è‡ªç„¶è¯­è¨€å¤„ç†æŠ€æœ¯",
        "æ¨èç³»ç»Ÿç®—æ³•",
        "è®¡ç®—æœºè§†è§‰å‘å±•",
        "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",  # é‡å¤æŸ¥è¯¢æµ‹è¯•ç¼“å­˜
        "äººå·¥æ™ºèƒ½ä¼¦ç†",
        "å¤§æ•°æ®åˆ†ææ–¹æ³•"
    ]
    
    print(f"ğŸ” å¼€å§‹æ‰§è¡Œ {len(queries)} ä¸ªæŸ¥è¯¢...\n")
    
    for i, query in enumerate(queries):
        print(f"ğŸ“ æŸ¥è¯¢ {i+1}: {query}")
        
        start_time = time.time()
        result = rag_service.search_with_fallback(query)
        duration = time.time() - start_time
        
        if result["success"]:
            source_icon = {
                "primary": "ğŸ¯",
                "fallback": "ğŸ”„",
                "cache": "ğŸ’¾"
            }.get(result["source"], "â“")
            
            print(f"   {source_icon} æˆåŠŸ ({result['source']}) - è€—æ—¶: {duration:.2f}s")
            print(f"   ğŸ“„ æ–‡æ¡£æ•°: {result.get('documents', 0)}")
            print(f"   ğŸ’¬ å›ç­”: {result['response'][:100]}...")
        else:
            print(f"   âŒ å¤±è´¥ - {result['error']} (è€—æ—¶: {duration:.2f}s)")
            print(f"   ğŸ’¬ é™çº§å›ç­”: {result['response']}")
        
        print()
        time.sleep(0.5)
    
    # æ˜¾ç¤ºæœåŠ¡ç»Ÿè®¡
    print("ğŸ“Š æœåŠ¡ç»Ÿè®¡:")
    
    # ç†”æ–­å™¨çŠ¶æ€
    print(f"   ğŸ”Œ å‘é‡å­˜å‚¨ç†”æ–­å™¨: {rag_service.vector_circuit_breaker.state.value}")
    print(f"   ğŸ¤– LLMç†”æ–­å™¨: {rag_service.llm_circuit_breaker.state.value}")
    
    # é™çº§æœåŠ¡ç»Ÿè®¡
    fallback_stats = rag_service.fallback_service.get_statistics()
    print(f"   ğŸ”„ é™çº§æœåŠ¡è°ƒç”¨: {fallback_stats['total_calls']}")
    print(f"   ğŸ’¾ ç¼“å­˜å‘½ä¸­: {fallback_stats['cache_hits']}")
    
    # æŒ‡æ ‡ç»Ÿè®¡
    metrics = rag_service.metrics.get_metrics_summary()
    print(f"\nğŸ“ˆ æ€§èƒ½æŒ‡æ ‡:")
    for name, data in metrics.items():
        if 'count' in data:
            print(f"   {name}: {data['count']} æ¬¡")
        elif 'avg' in data:
            print(f"   {name}: å¹³å‡ {data['avg']:.2f}s")

if __name__ == "__main__":
    demo_rag_integration()
    
    print("\nğŸ¯ å®éªŒå››å®Œæˆï¼RAGç³»ç»Ÿå®¹é”™æœºåˆ¶é›†æˆæ¼”ç¤ºç»“æŸã€‚")
```

### 4.2 è¿è¡Œå®éªŒå››
```bash
python rag_integration_demo.py
```

## å®éªŒæ€»ç»“

### å®Œæˆå®éªŒåï¼Œè¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ•…éšœæ³¨å…¥çš„ä»·å€¼**ï¼š
   - æ•…éšœæ³¨å…¥å¸®åŠ©å‘ç°äº†å“ªäº›æ½œåœ¨é—®é¢˜ï¼Ÿ
   - ä¸åŒæ•…éšœç±»å‹å¯¹ç³»ç»Ÿçš„å½±å“æœ‰ä½•ä¸åŒï¼Ÿ

2. **æ¢å¤æœºåˆ¶æ•ˆæœ**ï¼š
   - é‡è¯•æœºåˆ¶åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æœ€æœ‰æ•ˆï¼Ÿ
   - ç†”æ–­å™¨å¦‚ä½•ä¿æŠ¤ç³»ç»Ÿå…å—çº§è”æ•…éšœï¼Ÿ
   - é™çº§æœåŠ¡å¦‚ä½•æå‡ç”¨æˆ·ä½“éªŒï¼Ÿ

3. **ç›‘æ§å‘Šè­¦ä½œç”¨**ï¼š
   - ç›‘æ§æŒ‡æ ‡å¦‚ä½•å¸®åŠ©åŠæ—¶å‘ç°é—®é¢˜ï¼Ÿ
   - å‘Šè­¦è§„åˆ™åº”è¯¥å¦‚ä½•è®¾ç½®æ‰åˆç†ï¼Ÿ

4. **é›†æˆåº”ç”¨æ€è€ƒ**ï¼š
   - åœ¨RAGç³»ç»Ÿä¸­ï¼Œå“ªäº›ç»„ä»¶æœ€éœ€è¦å®¹é”™ä¿æŠ¤ï¼Ÿ
   - å¦‚ä½•å¹³è¡¡ç³»ç»Ÿæ€§èƒ½å’Œå¯é æ€§ï¼Ÿ

### æ‰©å±•ç»ƒä¹ 

1. **è‡ªå®šä¹‰æ•…éšœç±»å‹**ï¼š
   - ä¸ºRAGç³»ç»Ÿè®¾è®¡ç‰¹å®šçš„æ•…éšœåœºæ™¯
   - å®ç°è‡ªå®šä¹‰çš„æ•…éšœæ³¨å…¥é€»è¾‘

2. **ä¼˜åŒ–æ¢å¤ç­–ç•¥**ï¼š
   - è°ƒæ•´é‡è¯•å‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœå˜åŒ–
   - è®¾è®¡æ›´æ™ºèƒ½çš„é™çº§ç­–ç•¥

3. **å®Œå–„ç›‘æ§ä½“ç³»**ï¼š
   - æ·»åŠ ä¸šåŠ¡ç›¸å…³çš„ç›‘æ§æŒ‡æ ‡
   - è®¾è®¡æ›´ç²¾ç¡®çš„å‘Šè­¦è§„åˆ™

### æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š
- æ•…éšœæ³¨å…¥ä»…åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰éœ€å……åˆ†æµ‹è¯•
- ç›‘æ§å‘Šè­¦è¦é¿å…è¿‡äºæ•æ„Ÿ
- æ¢å¤æœºåˆ¶å‚æ•°éœ€æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´

---

**å®éªŒå®Œæˆæ ‡å¿—**ï¼š
- âœ… æˆåŠŸè¿è¡Œæ‰€æœ‰å››ä¸ªå®éªŒ
- âœ… è§‚å¯Ÿåˆ°æ•…éšœæ³¨å…¥å’Œæ¢å¤æœºåˆ¶çš„æ•ˆæœ
- âœ… ç†è§£ç›‘æ§å‘Šè­¦çš„ä½œç”¨
- âœ… æŒæ¡åœ¨RAGç³»ç»Ÿä¸­çš„é›†æˆæ–¹æ³•

**ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼š
- æ·±å…¥å­¦ä¹ Chaos Engineering
- ç ”ç©¶å¾®æœåŠ¡å®¹é”™æ¨¡å¼
- æ¢ç´¢æ›´é«˜çº§çš„ç›‘æ§æŠ€æœ¯